<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartkick"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
  /* --- WRAPPER & GLOBAL --- */
  .users-dash-wrapper {
    padding: 40px 4vw 80px 4vw;
    max-width: 1600px;
    margin: 0 auto;
    background-color: #f8f9fa;
    min-height: 100vh;
    font-family: 'IBM Plex Sans', sans-serif;
    color: #202020;
  }

  /* --- HEADER --- */
  .users-dash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
  }

  .users-dash-title {
    font-size: 32px;
    font-weight: 500;
    color: #202020;
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 0;
  }

  .users-dash-back-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: #fff;
    border: 1px solid #eee;
    transition: all 0.2s ease;
  }
  .users-dash-back-link:hover {
    background-color: #f0f0f0;
    transform: translateX(-2px);
  }

  /* Selecteur Période */
  .users-dash-period-selector {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 50px;
    padding: 4px;
    display: flex;
    gap: 4px;
  }

  .period-btn {
    padding: 8px 20px;
    border-radius: 40px;
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 500;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }

  .period-btn:hover {
    color: #202020;
    background-color: #f5f5f5;
  }

  .period-btn.active {
    background-color: #202020;
    color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* --- KPI CARDS --- */
  .users-dash-kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Légèrement ajusté pour 5 cartes */
    gap: 24px;
    margin-bottom: 32px;
  }

  .users-dash-kpi-card {
    background: #fff;
    padding: 24px;
    border-radius: 16px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 140px;
    transition: transform 0.2s;
  }
  .users-dash-kpi-card:hover {
    transform: translateY(-4px);
  }

  .kpi-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .kpi-label {
    font-size: 14px;
    font-weight: 500;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .kpi-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
  }
  .kpi-icon svg { width: 20px; height: 20px; fill: #202020; }

  .bg-blue-light { background-color: #E3F2FD; }
  .bg-green-light { background-color: #E8F5E9; }
  .bg-orange-light { background-color: #FFF3E0; }
  .bg-purple-light { background-color: #F3E5F5; }
  .bg-yellow-light { background-color: #FFF8E1; } /* Nouvelle couleur pour Newsletter */

  .kpi-value {
    font-size: 36px;
    font-weight: 500;
    color: #202020;
    /* margin-top retiré ici car on utilise un conteneur flex */
  }

  /* --- GRAPHIQUES --- */
  .users-dash-main-chart-section {
    background: #fff;
    border-radius: 16px;
    padding: 32px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    margin-bottom: 32px;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .chart-tabs {
    display: flex;
    gap: 24px;
    border-bottom: 2px solid #f0f0f0;
  }

  .chart-tab {
    padding-bottom: 12px;
    font-size: 16px;
    font-weight: 500;
    color: #888;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: color 0.2s;
  }
  .chart-tab:hover { color: #202020; }
  .chart-tab.active { color: #202020; border-bottom-color: #202020; }

  .chart-container { display: none; animation: fadeIn 0.3s ease; }
  .chart-container.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .users-dash-secondary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 48px;
  }

  .secondary-card {
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
  }

  .secondary-title {
    font-size: 16px;
    font-weight: 600;
    color: #202020;
    margin-bottom: 20px;
    display: block;
  }

  /* --- TABLE & TOOLBAR --- */
  .users-dash-toolbar {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    border: 1px solid #e9e9e9;
  }
  .users-dash-toolbar form { display: flex; gap: 12px; flex: 1; }

  .users-dash-search { position: relative; flex: 1; }
  .users-dash-search input {
    width: 100%; padding: 12px 16px 12px 40px;
    border: 1px solid #e0e0e0; border-radius: 8px;
    font-size: 14px; background: #f9f9f9; color: #202020; font-weight: 500;
  }
  .users-dash-search svg {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    width: 18px; height: 18px; fill: #888;
  }

  .users-dash-select {
    padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 8px;
    background: #fff; font-size: 14px; font-weight: 500; color: #202020; cursor: pointer;
  }

  .users-dash-table-container {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    border: 1px solid #f0f0f0;
    overflow: hidden;
    margin-bottom: 48px;
  }

  .users-dash-table { width: 100%; border-collapse: collapse; }
  .users-dash-table th {
    background-color: #fafafa; padding: 18px 24px; text-align: left;
    font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase;
    border-bottom: 1px solid #eee;
  }
  .users-dash-table td {
    padding: 18px 24px; border-bottom: 1px solid #f5f5f5;
    font-size: 14px; font-weight: 500; color: #202020; vertical-align: middle;
  }
  .users-dash-table tr:hover { background-color: #fcfcfc; }

  /* Avatars & Badges */
  .users-dash-avatar {
    width: 42px; height: 42px; border-radius: 50%; background-color: #eee;
    margin-right: 16px; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600; color: #666;
  }
  .users-dash-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .badge { padding: 6px 12px; border-radius: 30px; font-size: 12px; font-weight: 600; }
  .badge-blue { background: #E3F2FD; color: #1565C0; }
  .badge-green { background: #E8F5E9; color: #2E7D32; }
  .badge-dark { background: #202020; color: #fff; }
  .badge-red { background: #FFEBEE; color: #C62828; }

  /* --- CARTE (MAP) --- */
  .users-dash-map-section {
    background: #fff;
    border-radius: 16px;
    padding: 32px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
  }

  .users-dash-map-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .users-dash-map-title {
    font-size: 18px;
    font-weight: 600;
    color: #202020;
  }

  #map {
    width: 100%;
    height: 500px;
    border-radius: 12px;
    background-color: #eee;
    z-index: 1;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .users-dash-secondary-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 768px) {
    .users-dash-secondary-grid { grid-template-columns: 1fr; }
    .users-dash-toolbar form { flex-direction: column; align-items: stretch; }
    .users-dash-header { flex-direction: column; align-items: flex-start; gap: 20px; }
  }
</style>
<div class="users-dash-wrapper">
  <div class="users-dash-header">
    <div style="display: flex; align-items: center; gap: 20px;">
      <%= link_to admin_root_path, class: "users-dash-back-link" do %>
        <svg style="width: 24px; height: 24px; fill: #202020;" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      <% end %>
      <h1 class="users-dash-title">Gestion des Utilisateurs</h1>
    </div>
    <div class="users-dash-period-selector">
      <%= link_to "7J", users_path(period: '7d'), class: "period-btn #{@period == '7d' ? 'active' : ''}" %>
      <%= link_to "30J", users_path(period: '30d'), class: "period-btn #{@period == '30d' ? 'active' : ''}" %>
      <%= link_to "60J", users_path(period: '60d'), class: "period-btn #{@period == '60d' ? 'active' : ''}" %>
      <%= link_to "90J", users_path(period: '90d'), class: "period-btn #{@period == '90d' ? 'active' : ''}" %>
      <%= link_to "12M", users_path(period: '12m'), class: "period-btn #{@period == '12m' ? 'active' : ''}" %>
    </div>
  </div>
  <div class="users-dash-kpi-grid">
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Total Membres</span>
        <div class="kpi-icon bg-blue-light">
          <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </div>
      </div>
      <div style="margin-top: auto;">
        <span class="kpi-value"><%= @total_users %></span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Nouveaux (<%= @period %>)</span>
        <div class="kpi-icon bg-green-light">
          <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
        </div>
      </div>
      <div style="margin-top: auto;">
        <span class="kpi-value" style="color: #2E7D32;">+<%= @new_users_period %></span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Actifs (<%= @period %>)</span>
        <div class="kpi-icon bg-orange-light">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </div>
      </div>
      <div style="margin-top: auto;">
        <span class="kpi-value"><%= @active_users_period %></span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Certifiés</span>
        <div class="kpi-icon bg-purple-light">
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
      </div>
      <div style="margin-top: auto;">
        <span class="kpi-value"><%= @certified_count %></span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Newsletter</span>
        <div class="kpi-icon bg-yellow-light">
          <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </div>
      </div>
      <div style="margin-top: auto;">
        <span class="kpi-value"><%= @newsletter_count %></span>
        <div style="font-size: 13px; color: #666; font-weight: 500;">sur <%= @total_users %> membres</div>
      </div>
    </div>
  </div>
  <div class="users-dash-main-chart-section">
    <div class="chart-header">
      <div class="chart-tabs">
        <div class="chart-tab active" onclick="switchChart('signups', this)">Inscriptions</div>
        <div class="chart-tab" onclick="switchChart('visits', this)">Visites</div>
      </div>
    </div>
    <div id="chart-signups" class="chart-container active">
      <%= area_chart @chart_signups, height: "300px", colors: ["#202020"], library: { scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [5, 5] } } } } %>
    </div>
    <div id="chart-visits" class="chart-container">
      <%= area_chart @chart_visits, height: "300px", colors: ["#4CAF50"], library: { scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [5, 5] } } } } %>
    </div>
  </div>
  <div class="users-dash-secondary-grid">
    <div class="secondary-card">
      <span class="secondary-title">Acquisition</span>
      <%= pie_chart @distrib_acquisition, donut: true, height: "200px", colors: ["#202020", "#666", "#999", "#ccc", "#eee"], legend: "bottom" %>
    </div>
    <div class="secondary-card">
      <span class="secondary-title">Répartition Statut</span>
      <%= pie_chart @distrib_statut, donut: true, height: "200px", colors: ["#2E7D32", "#1565C0", "#F9A825"], legend: "bottom" %>
    </div>
    <div class="secondary-card">
      <span class="secondary-title">Niveau d'études</span>
      <%= bar_chart @distrib_levels, height: "200px", colors: ["#202020"] %>
    </div>
  </div>
  <div class="users-dash-toolbar">
    <%= form_with url: users_path, method: :get, local: true, style: "display:contents;" do |f| %>
      <%= hidden_field_tag :period, @period %>
      <div class="users-dash-search">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <%= f.text_field :query, value: params[:query], placeholder: "Rechercher par nom, email..." %>
      </div>
      <%= f.select :statut, options_for_select([["Tous les statuts", ""], "Etudiant", "Professionnel"], params[:statut]), {}, { class: "users-dash-select", onchange: "this.form.submit()" } %>
      <%= f.select :role, options_for_select([["Tous les rôles", ""], "user", "admin"], params[:role]), {}, { class: "users-dash-select", onchange: "this.form.submit()" } %>
      <% if params[:query].present? || params[:statut].present? || params[:role].present? %>
        <%= link_to "Effacer", users_path(period: @period), style: "font-weight: 500; color: #666; font-size: 14px;" %>
      <% end %>
    <% end %>
  </div>
  <%= turbo_frame_tag "members_table" do %>
    <div class="users-dash-table-container">
      <table class="users-dash-table">
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Statut</th>
            <th>Établissement</th>
            <th>Inscription</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @paginated_users.each do |user| %>
            <tr>
              <td>
                <div style="display:flex; align-items:center;">
                  <div class="users-dash-avatar">
                    <% if user.profile_image.present? %>
                      <%= image_tag user.profile_image, alt: user.firstname %>
                    <% else %>
                      <%= user.firstname&.first %>
                    <% end %>
                  </div>
                  <div>
                    <div style="font-weight: 600; color: #202020;"><%= user.firstname %> <%= user.lastname %></div>
                    <div style="font-size: 12px; color: #888;"><%= user.email %></div>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge badge-<%= user.statut == 'Etudiant' ? 'blue' : 'green' %>">
                  <%= user.statut || "N/A" %>
                </span>
                <% if user.admin? %>
                  <span class="badge badge-dark">Admin</span>
                <% end %>
              </td>
              <td><%= user.etablissement&.name || "-" %></td>
              <td>
                <%= user.created_at.strftime("%d/%m/%Y") %>
                <div style="font-size: 11px; color: #999;"><%= time_ago_in_words(user.created_at) %></div>
              </td>
              <td style="text-align: right;">
                <%= link_to user_path(user), style: "text-decoration:none;", data: { turbo_frame: "_top" } do %>
                  <div style="width: 32px; height: 32px; display:inline-flex; align-items:center; justify-content:center; border:1px solid #eee; border-radius:8px; background:#fff; cursor: pointer;">
                    <svg style="width:16px; height:16px; fill:#202020;" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <div style="padding: 24px; display: flex; justify-content: center; border-top: 1px solid #eee;">
        <%= paginate @paginated_users %>
      </div>
    </div>
  <% end %>
  <div class="users-dash-map-section">
    <div class="users-dash-map-header">
      <span class="users-dash-map-title">Géolocalisation des membres</span>
    </div>
    <div id="map"></div>
  </div>
</div>
<script>
  // Tabs Graphique
  function switchChart(chartId, tabElement) {
    document.querySelectorAll('.chart-container').forEach(el => el.classList.remove('active'));
    document.getElementById('chart-' + chartId).classList.add('active');
    document.querySelectorAll('.chart-tab').forEach(el => el.classList.remove('active'));
    tabElement.classList.add('active');
  }

  // Initialisation Carte
  document.addEventListener("turbo:load", () => {
    const mapElement = document.getElementById('map');
    if (mapElement && !mapElement._leaflet_id && typeof L !== 'undefined') {
      const map = L.map('map').setView([46.603354, 1.888334], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const markers = L.markerClusterGroup();
      const userLocations = [
        <% @users_for_map.each do |user| %>
          <% if user.etablissement&.latitude && user.etablissement&.longitude %>
            { lat: <%= user.etablissement.latitude %>, lng: <%= user.etablissement.longitude %>, name: "<%= j user.firstname %> <%= j user.lastname %>" },
          <% end %>
        <% end %>
      ];

      userLocations.forEach(u => {
        markers.addLayer(L.marker([u.lat, u.lng]).bindPopup(`<b>${u.name}</b>`));
      });
      map.addLayer(markers);
    }
  });
</script>