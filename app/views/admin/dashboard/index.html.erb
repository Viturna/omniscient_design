<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartkick"></script>
<style>
  h2{
    margin-top: 0;
    padding-top: 0;
  }
  .admin-dashboard-wrapper {
    padding: 40px 4vw;
    max-width: 1500px;
    margin: 0 auto;
  }

  /* Header Section */
  .dashboard-header {
    margin-bottom: 30px;
  }

  .dashboard-date {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .dashboard-title {
    font-size: 28px;
    font-weight: 500;
    color: #202020;
    margin: 0;
  }

  /* Main Grid Layout */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 2fr 1fr; /* Ratio 2/3 - 1/3 */
    gap: 24px;
    align-items: start;
  }

  /* Cards Generic Style */
  .dash-card {
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    border: none;
  }

  /* SECTION GAUCHE */
  .left-column {
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 42vw;
  }

  .events-card {
    min-height: 300px;
  }

  .card-title-dashboard {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 20px;
    color: #202020;
  }

  /* Raccourcis (Shortcuts) Row */
  .shortcuts-row {
    width: 100%;
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 5px;
  }

  .shortcut-pill {
    flex: 1;
    background: #fff;
    border-radius: 12px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: #202020;
    font-weight: 500;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    transition: transform 0.2s;
    min-width: 150px;
  }

  .shortcut-pill:hover {
    transform: translateY(-2px);
    background-color: #fcfcfc;
  }

  /* Style du cercle coloré */
  .shortcut-icon-circle {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* Style de l'image à l'intérieur */
  .shortcut-icon-circle img {
    width: 50%;
    height: 50%;
    object-fit: contain;
    display: block;
  }

  /* SECTION DROITE */
  .right-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 20px 25px;
    background: #fff;
    border-radius: 16px;
    width: 21vw;
  }

  .section-label {
    font-size: 16px;
    font-weight: 500;
    color: #202020;
    margin-bottom: 0;
  }

  .pie-chart-card {
    background: #F5F6F8;
    border-radius: 16px;
    padding: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 250px;
  }

  /* Petite grille de stats */
  .mini-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .mini-stat-card {
    background: #F5F6F8;
    padding: 20px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    min-height: 110px;
  }

  .mini-stat-card h3 {
    font-size: 24px;
    font-weight: 600;
    margin: 8px 0 4px 0;
    color: #202020;
  }

  .mini-stat-card p {
    font-size: 12px;
    color: #666;
    margin: 0;
  }

  .mini-stat-card.green {
    background-color: #D4EDDA;
    color: #155724;
  }

  .mini-stat-card.green h3 {
    color: #28a745;
  }

  .mini-stat-card.green p {
    color: #155724;
  }

  .icon-small {
    margin-bottom: 5px;
  }

  /* Notifications */
  .notification-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .notification-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .notification-item:last-child {
    border-bottom: none;
  }

  .notif-icon {
    width: 36px;
    height: 36px;
    background: #F5F5F5;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
  }

  .notif-content {
    flex: 1;
  }

  .notif-title {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
    display: block;
  }

  .notif-body {
    font-size: 13px;
    color: #666;
    display: block;
  }

  .notif-time {
    font-size: 12px;
    color: #999;
    white-space: nowrap;
    margin-left: 10px;
  }

  /* Filtres Graphique */
  .chart-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .chart-filters {
    display: flex;
    gap: 8px;
  }

  .chart-btn {
    background: none;
    border: 1px solid #ddd;
    padding: 4px 10px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    color: #666;
    font-weight: 500;
    transition: all 0.2s;
  }

  .chart-btn:hover {
    background: #f0f0f0;
  }

  .chart-btn.active {
    background: #202020;
    color: #fff;
    border-color: #202020;
  }
</style>
<div class="admin-dashboard-wrapper">
  <div class="dashboard-header">
    <div class="dashboard-date">
      <%= I18n.l(Date.today, format: "%A %d %B %Y").capitalize %>
    </div>
    <h1 class="dashboard-title">Bienvenue sur le dashboard, <%= current_user.firstname %></h1>
  </div>
  <div class="dashboard-grid">
    <div class="left-column">
      <div class="dash-card events-card">
        <h2 class="card-title-dashboard">Derniers évènements</h2>
        <% if @notifications.any? %>
          <ul class="notification-list">
            <% @notifications.each do |notif| %>
              <li class="notification-item">
                <div class="notif-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="#666"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                </div>
                <div class="notif-content">
                  <span class="notif-title"><%= notif.title %></span>
                  <span class="notif-body"><%= truncate(notif.message, length: 60) %></span>
                </div>
                <span class="notif-time"><%= time_ago_in_words(notif.created_at) %></span>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div style="color: #999; font-style: italic; display: flex; align-items: center; justify-content: center; height: 200px;">
            Aucun événement récent.
          </div>
        <% end %>
      </div>
      <div class="shortcuts-row">
        <a href="https://analytics.google.com" target="_blank" class="shortcut-pill">
          <div class="shortcut-icon-circle" style="background-color: #FFF8E1;">
            <%= image_tag "admin/analytics.png", alt: "Analytics" %>
          </div>
          <div style="display:flex; flex-direction:column;">
            <span style="font-size:10px; color:#999;">Raccourci</span>
            <span>Google Analytics</span>
          </div>
        </a>
        <a href="https://search.google.com" target="_blank" class="shortcut-pill">
          <div class="shortcut-icon-circle" style="background-color: #E6F4EA;">
            <%= image_tag "admin/search-console.png", alt: "Search Console" %>
          </div>
          <div style="display:flex; flex-direction:column;">
            <span style="font-size:10px; color:#999;">Raccourci</span>
            <span>Search Console</span>
          </div>
        </a>
        <a href="#" class="shortcut-pill">
          <div class="shortcut-icon-circle" style="background-color: #E1F5FE;">
            <%= image_tag "admin/play-console.png", alt: "Play Console" %>
          </div>
          <div style="display:flex; flex-direction:column;">
            <span style="font-size:10px; color:#999;">Raccourci</span>
            <span>Play Console</span>
          </div>
        </a>
        <a href="#" class="shortcut-pill">
          <div class="shortcut-icon-circle" style="background-color: #F0F2F5;">
            <%= image_tag "admin/app-store.png", alt: "App Store" %>
          </div>
          <div style="display:flex; flex-direction:column;">
            <span style="font-size:10px; color:#999;">Raccourci</span>
            <span>App Store</span>
          </div>
        </a>
      </div>
      <div class="dash-card events-card">
        <div class="chart-header-row">
          <h2 class="card-title-dashboard" style="margin-bottom:0;">Nouvelles inscriptions</h2>
          <div class="chart-filters">
            <button class="chart-btn" onclick="updateChart('7d')" data-period="7d">7J</button>
            <button class="chart-btn" onclick="updateChart('30d')" data-period="30d">30J</button>
            <button class="chart-btn" onclick="updateChart('12m')" data-period="12m">12M</button>
          </div>
        </div>
        <%= area_chart @users_over_time, height: "250px", colors: ["#202020"], library: { scales: { x: { display: true }, y: { display: false, grid: { display: false } } } } %>
      </div>
    </div>
    <div class="right-column">
      <h3 class="section-label">Les statistiques</h3>
      <div class="pie-chart-card">
        <%= pie_chart User.group(:role).count, donut: false, colors: ["#5D5FEF", "#A5A6F6", "#E5E5E5"], height: "180px", legend: false %>
      </div>
      <div class="mini-stats-grid">
        <div class="mini-stat-card">
          <div class="icon-small">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#333"><path d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.67 0-8 1.34-8 4v3h18v-3c0-2.66-5.33-4-8-4zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v3h5v-3c0-2.66-5.33-4-6-4z"/></svg>
          </div>
          <h3><%= User.count %></h3>
          <p>Utilisateurs.ices</p>
        </div>
        <div class="mini-stat-card green">
          <h3>+<%= @new_users_this_week %></h3>
          <p>Cette semaine</p>
        </div>
        <div class="mini-stat-card">
          <div class="icon-small">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#333"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>
          </div>
          <h3><%= Oeuvre.where(validation: true).count %></h3>
          <p>Références</p>
        </div>
        <div class="mini-stat-card">
          <div class="icon-small">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#333"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          </div>
          <h3><%= Designer.where(validation: true).count %></h3>
          <p>Designers</p>
        </div>
        <div class="mini-stat-card">
          <div class="icon-small">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#333"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
          </div>
          <h3><%= @avg_visits_30d %></h3>
          <p>Visites / user (30j)</p>
        </div>
        <div class="mini-stat-card">
          <div class="icon-small">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#333"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
          </div>
          <h3><%= @avg_visits_12m %></h3>
          <p>Visites / user (12 mois)</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function updateChart(period) {
    const url = new URL(window.location);
    url.searchParams.set('period', period);
    window.location = url;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const period = params.get('period') || '30d';

    document.querySelectorAll('.chart-btn').forEach(btn => {
      if(btn.dataset.period === period) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  });
</script>