<% content_for :title, "S'inscrire - Omniscient Design" %>
<% content_for :description, "Inscris-toi sur Omniscient Design pour devenir un vrai pro dans l'univers du design. Rejoins une communauté de passionnés prête à tout pour rendre le design accessible." %>
<div class="log" style="color:#FFF; min-height:100vh;">
  <section class="box-log">
    <div class="form"  data-controller="registration"
     data-registration-triggers-value='["etudiant", "enseignant"]'>
      <h1 style="margin-top:0;"><%= t('devise.registration.title') %></h1>
      <div class="field input-flex">
        <p class="title-boxlog"><%= t('devise.registration.main_info') %></p>
      </div>
      <div class="flex-login-oauth">
        <%= button_to user_google_oauth2_omniauth_authorize_path, method: :post, data: { turbo: false }, class: "button", style: "width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; font-weight: 500;" do %>
          <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M18.541 9.67468C18.541 9.0039 18.4808 8.35892 18.369 7.73975H9.45972V11.3989H14.5507C14.3315 12.5814 13.665 13.5832 12.6631 14.254V16.6275H15.7203C17.509 14.9807 18.541 12.5556 18.541 9.67468Z" fill="#4285F4"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.45962 18.9192C12.0137 18.9192 14.1551 18.0721 15.7202 16.6274L12.663 14.2538C11.8159 14.8214 10.7324 15.1568 9.45962 15.1568C6.9958 15.1568 4.91037 13.4928 4.1665 11.2568H1.0061V13.7078C2.56265 16.7993 5.76174 18.9192 9.45962 18.9192Z" fill="#34A853"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M4.16656 11.257C3.97736 10.6894 3.86987 10.0832 3.86987 9.45968C3.86987 8.8362 3.97736 8.22992 4.16656 7.66234V5.21143H1.00617C0.365487 6.48848 0 7.93323 0 9.45968C0 10.9861 0.365487 12.4309 1.00617 13.7079L4.16656 11.257Z" fill="#FBBC05"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.45962 3.76237C10.8485 3.76237 12.0954 4.23966 13.0758 5.17702L15.789 2.46382C14.1508 0.937368 12.0094 0 9.45962 0C5.76174 0 2.56265 2.11983 1.0061 5.21142L4.1665 7.66234C4.91037 5.42641 6.9958 3.76237 9.45962 3.76237Z" fill="#EA4335"/>
          </svg>
          S'inscrire avec Google
        <% end %>
        <%= button_to user_apple_omniauth_authorize_path, method: :post, data: { turbo: false }, class: "button", style: "width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px;" do %>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_751_15589)">
              <rect width="19.7419" height="19.7419" fill="white"/>
              <path d="M17.505 15.155C17.2189 15.816 16.8802 16.4245 16.4878 16.9839C15.9529 17.7464 15.515 18.2743 15.1775 18.5674C14.6543 19.0486 14.0938 19.295 13.4935 19.309C13.0626 19.309 12.5429 19.1864 11.938 18.9376C11.331 18.69 10.7733 18.5674 10.2633 18.5674C9.72843 18.5674 9.1548 18.69 8.54122 18.9376C7.92671 19.1864 7.43167 19.316 7.05318 19.3288C6.47756 19.3534 5.9038 19.1 5.3311 18.5674C4.96557 18.2486 4.50837 17.7021 3.96066 16.9278C3.37301 16.101 2.88988 15.1422 2.51139 14.0491C2.10603 12.8684 1.90283 11.7251 1.90283 10.6183C1.90283 9.35037 2.1768 8.25682 2.72557 7.34043C3.15684 6.60435 3.7306 6.0237 4.44869 5.59745C5.16679 5.17119 5.94269 4.95397 6.77827 4.94008C7.23548 4.94008 7.83504 5.0815 8.58011 5.35944C9.32308 5.63832 9.80014 5.77974 10.0093 5.77974C10.1657 5.77974 10.6956 5.61438 11.594 5.2847C12.4436 4.97897 13.1607 4.85237 13.7481 4.90224C15.3398 5.0307 16.5357 5.65817 17.331 6.78863C15.9074 7.65118 15.2032 8.8593 15.2172 10.4091C15.2301 11.6163 15.668 12.6209 16.5287 13.4185C16.9187 13.7887 17.3543 14.0748 17.839 14.278C17.7339 14.5828 17.6229 14.8748 17.505 15.155V15.155ZM13.8544 0.789627C13.8544 1.73581 13.5087 2.61926 12.8197 3.43697C11.9882 4.40907 10.9824 4.97079 9.89181 4.88215C9.87791 4.76864 9.86986 4.64917 9.86986 4.52363C9.86986 3.6153 10.2653 2.6432 10.9675 1.84838C11.3181 1.44594 11.764 1.11133 12.3047 0.844398C12.8442 0.58145 13.3545 0.436035 13.8345 0.411133C13.8485 0.537623 13.8544 0.664121 13.8544 0.789615V0.789627Z" fill="#20201F"/>
            </g>
            <defs>
              <clipPath id="clip0_751_15589">
                <rect width="19.7419" height="19.7419" fill="white"/>
              </clipPath>
            </defs>
          </svg>
          S'inscrire avec Apple
        <% end %>
      </div>
      <div style="display: flex;">
        <hr style="border: 0; border-top: 1px solid #FFF; width: 100%;">
        <span style="color: #FFF; padding: 0 15px;">OU</span>
        <hr style="border: 0; border-top: 1px solid #FFF; width: 100%;">
      </div>
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :post, multipart: true }) do |f| %>
        <%= f.hidden_field :provider %>
        <%= f.hidden_field :uid %>
        <% if resource.errors.any? %>
          <div id="error_explanation">
            <p style="color:red;"><%= pluralize(resource.errors.count, "erreur") %> empêchent cette inscription :</p>
            <ul>
              <% resource.errors.full_messages.each do |message| %>
                <li style="color:red;"><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
        <% unless resource.provider.present? %>
          <div class="field input-flex">
            <%= f.label :email, t('devise.registration.label_email') %>
            <%= f.email_field :email, autocomplete: "email", placeholder: t('devise.registration.email_placeholder') %>
          </div>
          <div class="field input-flex" data-controller="show-password">
            <%= f.label :password, t('devise.registration.label_password') %>
            <div class="password-container">
              <%= f.password_field :password,
                    autocomplete: "new-password",
                    placeholder: t('devise.registration.password_placeholder'),
                    id: "password-field-1",
                    data: { "show-password-target": "passwordField" } %>
              <button type="button" 
                    data-action="click->show-password#toggle" class="toggle-password">
                <svg class="show-password-icon" data-show-password-target="showIcon" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15.9972 6.66699C10.5598 6.66699 5.6745 10.791 2.85984 15.311C2.73184 15.523 2.6665 15.7617 2.6665 16.0003C2.6665 16.239 2.7305 16.4777 2.8585 16.6897C5.6745 21.2097 10.5598 25.3337 15.9972 25.3337C21.5212 25.3337 26.3918 21.2137 29.1492 16.6763C29.2718 16.4683 29.3332 16.2337 29.3332 16.0003C29.3332 15.767 29.2718 15.5323 29.1492 15.3243C26.3918 10.787 21.5212 6.66699 15.9972 6.66699ZM15.9998 10.667C18.9438 10.667 21.3332 13.0563 21.3332 16.0003C21.3332 18.9443 18.9438 21.3337 15.9998 21.3337C13.0558 21.3337 10.6665 18.9443 10.6665 16.0003C10.6665 13.0563 13.0558 10.667 15.9998 10.667ZM15.9998 12.667C17.8398 12.667 19.3332 14.1603 19.3332 16.0003C19.3332 17.8403 17.8398 19.3337 15.9998 19.3337C14.1598 19.3337 12.6665 17.8403 12.6665 16.0003C12.6665 14.1603 14.1598 12.667 15.9998 12.667Z" fill="#202020"/>
                </svg>
                <svg class="hide-password-icon" data-show-password-target="hideIcon" style="display: none;" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line x1="7.64315" y1="28.4933" x2="20.0066" y2="2.2608" stroke="#202020" stroke-width="3"/>
                  <path d="M22.1016 8.34375C25.0132 9.96161 27.4726 12.565 29.1494 15.3242C29.2719 15.5321 29.333 15.7668 29.333 16C29.333 16.2334 29.272 16.4688 29.1494 16.6768C26.392 21.2141 21.521 25.334 15.9971 25.334C15.3793 25.334 14.7692 25.2778 14.168 25.1768L15.9795 21.333C15.9863 21.333 15.9932 21.334 16 21.334C18.9439 21.3339 21.333 18.9439 21.333 16C21.3329 14.7041 20.8691 13.5162 20.0996 12.5918L22.1016 8.34375ZM15.9971 6.66699C17.1437 6.66699 18.2615 6.84701 19.3389 7.16895L17.5781 10.9053C17.0793 10.7508 16.5494 10.667 16 10.667C13.0561 10.667 10.6672 13.0561 10.667 16C10.667 17.864 11.6252 19.5052 13.0752 20.459L11.2617 24.3047C7.797 22.8028 4.8234 19.8435 2.8584 16.6895C2.73049 16.4775 2.66602 16.2386 2.66602 16C2.66607 15.7615 2.73143 15.5225 2.85938 15.3105C5.67402 10.7906 10.5598 6.66706 15.9971 6.66699ZM19.0859 14.7422C19.2445 15.1305 19.333 15.5549 19.333 16C19.333 17.494 18.3484 18.7594 16.9932 19.1826L19.0859 14.7422ZM16 12.667C16.244 12.667 16.4818 12.6933 16.7109 12.7432L13.9414 18.6201C13.1659 18.0094 12.667 17.0629 12.667 16C12.6672 14.1601 14.1601 12.667 16 12.667Z" fill="#202020"/>
                </svg>
              </button>
            </div>
            <i style="margin-bottom: 16px;">Votre mot de passe doit comporter au moins 6 caractères, incluant une majuscule, une minuscule, un chiffre et un caractère spécial.</i>
          </div>
          <div class="field input-flex" data-controller="show-password">
            <%= f.label :password_confirmation, t('devise.registration.label_password_confirmation') %>
            <div class="password-container">
              <%= f.password_field :password_confirmation,
                    autocomplete: "new-password",
                    placeholder: t('devise.registration.password_confirmation_placeholder'),
                    id: "password-field-2",
                    data: { "show-password-target": "passwordField" } %>
              <button type="button" 
                    data-action="click->show-password#toggle" class="toggle-password">
                <svg class="show-password-icon" data-show-password-target="showIcon" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15.9972 6.66699C10.5598 6.66699 5.6745 10.791 2.85984 15.311C2.73184 15.523 2.6665 15.7617 2.6665 16.0003C2.6665 16.239 2.7305 16.4777 2.8585 16.6897C5.6745 21.2097 10.5598 25.3337 15.9972 25.3337C21.5212 25.3337 26.3918 21.2137 29.1492 16.6763C29.2718 16.4683 29.3332 16.2337 29.3332 16.0003C29.3332 15.767 29.2718 15.5323 29.1492 15.3243C26.3918 10.787 21.5212 6.66699 15.9972 6.66699ZM15.9998 10.667C18.9438 10.667 21.3332 13.0563 21.3332 16.0003C21.3332 18.9443 18.9438 21.3337 15.9998 21.3337C13.0558 21.3337 10.6665 18.9443 10.6665 16.0003C10.6665 13.0563 13.0558 10.667 15.9998 10.667ZM15.9998 12.667C17.8398 12.667 19.3332 14.1603 19.3332 16.0003C19.3332 17.8403 17.8398 19.3337 15.9998 19.3337C14.1598 19.3337 12.6665 17.8403 12.6665 16.0003C12.6665 14.1603 14.1598 12.667 15.9998 12.667Z" fill="#202020"/>
                </svg>
                <svg class="hide-password-icon" data-show-password-target="hideIcon" style="display: none;" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line x1="7.64315" y1="28.4933" x2="20.0066" y2="2.2608" stroke="#202020" stroke-width="3"/>
                  <path d="M22.1016 8.34375C25.0132 9.96161 27.4726 12.565 29.1494 15.3242C29.2719 15.5321 29.333 15.7668 29.333 16C29.333 16.2334 29.272 16.4688 29.1494 16.6768C26.392 21.2141 21.521 25.334 15.9971 25.334C15.3793 25.334 14.7692 25.2778 14.168 25.1768L15.9795 21.333C15.9863 21.333 15.9932 21.334 16 21.334C18.9439 21.3339 21.333 18.9439 21.333 16C21.3329 14.7041 20.8691 13.5162 20.0996 12.5918L22.1016 8.34375ZM15.9971 6.66699C17.1437 6.66699 18.2615 6.84701 19.3389 7.16895L17.5781 10.9053C17.0793 10.7508 16.5494 10.667 16 10.667C13.0561 10.667 10.6672 13.0561 10.667 16C10.667 17.864 11.6252 19.5052 13.0752 20.459L11.2617 24.3047C7.797 22.8028 4.8234 19.8435 2.8584 16.6895C2.73049 16.4775 2.66602 16.2386 2.66602 16C2.66607 15.7615 2.73143 15.5225 2.85938 15.3105C5.67402 10.7906 10.5598 6.66706 15.9971 6.66699ZM19.0859 14.7422C19.2445 15.1305 19.333 15.5549 19.333 16C19.333 17.494 18.3484 18.7594 16.9932 19.1826L19.0859 14.7422ZM16 12.667C16.244 12.667 16.4818 12.6933 16.7109 12.7432L13.9414 18.6201C13.1659 18.0094 12.667 17.0629 12.667 16C12.6672 14.1601 14.1601 12.667 16 12.667Z" fill="#202020"/>
                </svg>
              </button>
            </div>
          </div>
        <% else %>
          <div class="field input-flex">
            <p class="title-boxlog">Inscription via Google</p>
            <p style="color: #FFF; opacity: 0.8; margin-bottom: 20px;">
              Vous vous inscrivez avec : <strong><%= resource.email %></strong>
            </p>
            <%= f.hidden_field :email %>
          </div>
        <% end %>
        <div class="field input-flex">
          <p class="title-boxlog"><%= t('devise.registration.additional_info') %></p>
        </div>
        <div class="field input-flex">
          <%= f.label :firstname, t('devise.registration.label_firstname') %>
          <%= f.text_field :firstname, autocomplete: "firstname", placeholder: t('devise.registration.firstname_placeholder') %>
        </div>
        <div class="field input-flex">
          <%= f.label :lastname, t('devise.registration.label_lastname') %>
          <%= f.text_field :lastname, autocomplete: "lastname", placeholder: t('devise.registration.lastname_placeholder') %>
        </div>
        <div class="field input-flex">
          <%= f.label :pseudo, t('devise.registration.label_pseudo') %>
          <%= f.text_field :pseudo, autocomplete: "pseudo", placeholder: t('devise.registration.pseudo_placeholder') %>
        </div>
        <div class="field input-flex">
          <%= f.label t('edit_profile.status') %>
          <%= f.select :statut,
          User::STATUTS.map { |key| [t("devise.registration.status_options.#{key}"), key] },
            { include_blank: t('devise.registration.status_blank', default: "Sélectionnez votre statut") },
            { class: "role-select form-control",
              required: true,
              data: {
                # CORRECTION ICI : Une seule action vers la nouvelle méthode unifiée
                action: "change->registration#toggleFields",
                registration_target: "statutSelect"
              } } %>
        </div>
        <div class="field input-flex" data-registration-target="establishmentField"
              style="<%= resource.statut == 'etudiant' || resource.statut == 'enseignant' ? '' : 'display: none;' %>">
          <%= f.label :etablissement_id, t('edit_profile.institution') %>
          <%= f.collection_select :etablissement_id,
        Etablissement.order(:city),
        :id,
        :all_info,
        { prompt: t('edit_profile.choose_institution') },
        { class: 'form-control etablissement-select' } %>
        </div>
        <div class="field input-flex" data-registration-target="studentField"
              style="<%= resource.statut == 'etudiant' ? '' : 'display: none;' %>">
          <%= f.label :study_level, "Niveau d'étude" %>
          <%= f.select :study_level,
            User::STUDY_LEVELS,
            { include_blank: "Sélectionnez votre niveau scolaire" },
            { class: "form-control level-select" } %>
        </div>
        <div class="field input-flex">
          <%= f.label :how_did_you_hear, t('devise.registration.label_how_did_you_hear') %>
          <%= f.select :how_did_you_hear,
                       options_for_select([
                         "Instagram",
                         "TikTok",
                         "LinkedIn",
                         "Pinterest",
                         t('devise.registration.how_did_you_hear.word_of_mouth', default: "Bouche à oreilles"),
                         t('devise.registration.how_did_you_hear.search', default: "Recherche internet"),
                         t('devise.registration.how_did_you_hear.other', default: "Autre")
                       ], selected: resource.how_did_you_hear),
                       { required: true },
                       { class: "form-control hear-select" } %>
        </div>
        <%# <div class="field">
          <%= f.text_field :referral_code, placeholder: "Code de parrainage" %>
        <%# </div> %>
        <div class="field rgpd">
          <%= f.check_box :rgpd_consent, required: true %>
          <%= f.label :rgpd_consent,
                (t('devise.registration.rgpd_label', privacy_policy: link_to(t('devise.registration.privacy_policy'), politiquedeconfidentialite_path, target: "_blank"))).html_safe,
                class: "rgpd-label" %>
        </div>
        <div class="actions">
          <%= f.submit t('devise.registration.submit'), class: "button dark btn-login" %>
        </div>
        <%= link_to t('devise.registration.login_link'), new_user_session_path, class: "sign-up-in" %>
        <p class="email-confirmation">
          <%= t('devise.registration.resend_confirmation', resend_link: link_to(t('devise.registration.resend_link_text'), new_user_confirmation_path, class: "sign-up-in")).html_safe %>
        </p>
      <% end %>
    </div>
  </section>
</div>
<script>
  document.addEventListener("turbo:load", () => {
  function initSelect2(selector, placeholder) {
    const elements = document.querySelectorAll(selector);
    elements.forEach(el => {
      if ($(el).hasClass("select2-hidden-accessible")) {
        $(el).select2('destroy'); // supprime l'ancienne instance
      }
      $(el).select2({
        placeholder: placeholder,
        allowClear: true,
        width: '100%',
        language: {
          inputTooShort: function() { return "Veuillez entrer plus de caractères..."; },
          searching: function() { return "Recherche en cours..."; },
          noResults: function() { return "Aucun résultat trouvé"; }
        }
      });
    });
  }

  initSelect2('.etablissement-select', 'Rechercher un établissement...');
  initSelect2('.hear-select', 'Comment avez-vous connu le site ?');
  initSelect2('.level-select', 'Sélectionnez votre niveau scolaire');

  });
</script>
<% content_for :recaptcha_script do %>
  <script src="https://www.google.com/recaptcha/api.js?render=<%= ENV["RECAPTCHA_SITE_KEY"] %>"></script>
<% end %>