<style>
  .profil .flex-form label {
    color: #202020;
  }

  body.dark-mode  .profil .flex-form label {
    color: #FFF;
  }

  hr{
    margin-top: 32px;
    width: 100%;
    border: 1px solid #202020
  }
  .delete{
    background-color: rgba(230, 24,24,0.15);
    color: #E61818;
  }
  .delete:hover{
    background-color: rgba(230, 24,24,0.35);
  }
  .delete-account{
    margin-top: 32px;
    width: 100%;
  }

  body.dark-mode hr{
    border: 1px solid #FFF;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background-color: #fff;
    padding: 32px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }

  .modal-content p {
    margin-bottom: 24px;
  }

  .modal-content textarea {
    width: calc(100% - 24px);
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: vertical;
    margin-bottom: 24px;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 16px;
  }
</style>
<section class="top-default-page">
  <%= link_to profil_path do%>
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12.632 6.94488C12.632 6.94488 6.63067 12.9516 4.29333 15.2902C4.09733 15.4849 4 15.7409 4 15.9969C4 16.2529 4.09733 16.5089 4.29333 16.7035C6.62933 19.0422 12.6293 25.0462 12.6293 25.0462C12.8227 25.2395 13.0773 25.3355 13.332 25.3355C13.5867 25.3342 13.8427 25.2369 14.0387 25.0409C14.4293 24.6502 14.4307 24.0196 14.044 23.6316L7.40933 16.9969H26.9987C27.5507 16.9969 27.9987 16.5489 27.9987 15.9969C27.9987 15.4449 27.5507 14.9969 26.9987 14.9969H7.40933L14.0467 8.35822C14.432 7.97288 14.4293 7.34355 14.0387 6.95288C13.8427 6.75688 13.5867 6.65822 13.332 6.65822C13.0773 6.65688 12.8253 6.75288 12.632 6.94488Z" fill="white"/>
    </svg>
  <%end%>
  <h1><%= t('edit_profile.account') %></h1>
</section>
<section class="grid-1 profil">
  <h2>Comptes associ√©s</h2>
  <div class="field">
    <% if resource.provider.present? %>
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: rgba(52, 168, 83, 0.1); border-radius: 8px; color: #202020;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <% if resource.provider == 'google_oauth2' %>
            <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
            <span>Li√© √† <strong>Google</strong></span>
          <% elsif resource.provider == 'apple' %>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="#000000" xmlns="http://www.w3.org/2000/svg"><path d="M15.283 13.192c-.256.591-.56 1.136-.91 1.636-.478.682-.871 1.154-1.173 1.417-.467.43-.967.651-1.503.663-.385 0-.85-.11-1.39-.332-.543-.221-1.041-.332-1.497-.332-.478 0-.991.11-1.539.332-.549.221-.991.337-1.329.349-.515.021-1.027-.205-1.539-.682-.327-.285-.735-.773-1.224-1.465-.525-.739-.957-1.596-1.295-2.574-.362-1.056-.543-2.078-.543-3.068 0-1.134.245-2.111.735-2.931.385-.658.897-1.177 1.539-1.558.642-.381 1.335-.575 2.082-.588.408 0 .944.127 1.61.375.664.249 1.091.375 1.278.375.14 0 .614-.148 1.417-.443.759-.273 1.4-.387 1.925-.342 1.423.115 2.492.676 3.203 1.687-1.272.771-1.902 1.851-1.889 3.237.012 1.08.403 1.978 1.173 2.691.349.331.738.587 1.171.769-.094.273-.193.534-.298.784v.001zM12.019.356c0 .846-.291 1.636-.907 2.367-.743.869-1.642 1.372-2.617 1.292-.012-.101-.02-.208-.02-.32 0-.812.353-1.681.98-2.392.314-.36.712-.659 1.195-.898.482-.235.938-.365 1.367-.387.012.113.018.226.018.338h-.016z"/></svg>
            <span>Li√© √† <strong>Apple</strong></span>
          <% end %>
        </div>
        <%= button_to unlink_provider_path, method: :delete, data: { turbo: false, confirm: "√ätes-vous s√ªr de vouloir d√©lier ce compte ? Vous devrez utiliser votre email et mot de passe pour vous connecter." }, class: "button large" do %>
          D√©lier
        <% end %>
      </div>
      <% unless resource.encrypted_password.present? %>
        <p style="font-size: 0.8rem; color: #E61818; margin-top: 5px;">Attention : Vous n'avez pas de mot de passe d√©fini. Si vous d√©liez ce compte, vous devrez utiliser "Mot de passe oubli√©" pour vous reconnecter.</p>
      <% end %>
    <% else %>
      <p style="margin-bottom: 15px;">Liez votre compte pour vous connecter en un clic :</p>
      <div style="display: flex; flex-direction: row; gap: 10px;">
        <%= button_to user_google_oauth2_omniauth_authorize_path, method: :post, data: { turbo: false }, class: "button", style: "display: flex; justify-content: center; align-items: center; gap: 10px; background-color: #fff; color: #202020; border: 1px solid #ddd;" do %>
          Lier mon compte Google
        <% end %>
        <%= button_to user_apple_omniauth_authorize_path, method: :post, data: { turbo: false }, class: "button", style: "display: flex; justify-content: center; align-items: center; gap: 10px; background-color: #000; color: #fff;" do %>
          Lier mon compte Apple
        <% end %>
      </div>
    <% end %>
  </div>

  <h2><%= t('edit_profile.public_profile') %></h2>
  <p class="desc-profil"><%= t('edit_profile.public_desc') %></p>
  
  <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, multipart: true, data: { turbo: false } }) do |f| %>
    <div class="flex-form" style="margin-top: 32px;" data-controller="registration" data-registration-triggers-value='["etudiant", "enseignant"]'>
      <%= render "users/shared/error_messages", resource: resource %>
      
      <div class="field" style="display:flex; align-items:center; gap:20px;">
        <div style="flex:1;">
          <%= f.label :profile_image, "Photo de profil" %>
          <%= f.file_field :profile_image, class: "form-control", accept: "image/*" %>
        </div>
        <div style="width:60px; height:60px; border-radius:50%; overflow:hidden; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; background:#eee;">
          <% if resource.profile_image.attached? %>
            <%= image_tag resource.profile_image.variant(resize_to_fill: [100, 100]), style:"width:100%; height:100%; object-fit:cover;" %>
          <% else %>
            <span style="color:#888; font-size:20px;">?</span>
          <% end %>
        </div>
      </div>

      <div class="field">
        <%= f.label :country_id, "Pays" %>
        <%= f.collection_select :country_id,
            Country.order(:country),
            :id,
            :country,
            { prompt: "S√©lectionnez votre pays" },
            { 
              class: "form-control", 
              data: { 
                controller: "select2",
                select2_placeholder_value: "S√©lectionnez votre pays"
              } 
            } %>
      </div>
      <div class="field">
        <%= f.label t('edit_profile.first_name') %>
        <%= f.text_field :firstname, autocomplete: "firstname", placeholder: "Pr√©nom" %>
      </div>
      <div class="field">
        <%= f.label t('edit_profile.last_name') %>
        <%= f.text_field :lastname, autocomplete: "lastname", placeholder: "Nom de famille" %>
      </div>
      <div class="field">
        <%= f.label t('edit_profile.username') %>
        <%= f.text_field :pseudo, autocomplete: "pseudo", placeholder: "Pseudo" %>
      </div>
      <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
        <div>Currently waiting confirmation for: <%= resource.unconfirmed_email %></div>
      <% end %>
      
      <hr>
      <h2><%= t('edit_profile.private_profile') %></h2>
      <div class="field">
        <%= f.label t('edit_profile.email') %>
        <%= f.email_field :email, autocomplete: "email" %>
      </div>
      <div class="field">
        <%= f.label t('edit_profile.status') %>
        <%= f.select :statut,
          User::STATUTS.map { |key| [t("devise.registration.status_options.#{key}"), key] },
            { include_blank: t('devise.registration.status_blank', default: "S√©lectionnez votre statut") },
            { class: "role-select form-control",
              required: true,
              data: { 
                action: "change->registration#toggleEstablishment",
                registration_target: "statutSelect" 
             } } %>
      </div>
      <div class="field" data-registration-target="establishmentField" 
              style="<%= resource.statut == 'etudiant' ? '' : 'display: none;' %>">
        <%= f.label :etablissement_id, t('edit_profile.institution') %>
        <%= f.collection_select :etablissement_id,
        Etablissement.order(:city),
        :id,
        :all_info,
        { prompt: t('edit_profile.choose_institution') },
        { 
          class: 'form-control',
          data: { 
            controller: "select2", 
            select2_placeholder_value: "Rechercher un √©tablissement..."
          } 
        } %>
      </div>
      <div class="field">
        <%= f.label t('edit_profile.password') %>
        <i>(<%= t('edit_profile.password_hint') %>)</i>
        <div class="password-container" data-controller="show-password">
          <%= f.password_field :password, 
                autocomplete: "new-password", 
                id: "password-field-1", 
                data: { "show-password-target": "passwordField" } %>
          <button type="button" data-action="click->show-password#toggle" class="toggle-password">
            </button>
        </div>
        <i>Votre mot de passe doit comporter au moins 6 caract√®res...</i>
      </div>
      <div class="field ">
        <%= f.label t('edit_profile.password_confirmation') %>
        <i>(<%= t('edit_profile.password_hint') %>)</i>
        <div class="password-container" data-controller="show-password">
          <%= f.password_field :password_confirmation, 
        autocomplete: "new-password", 
        id: "password-field-2", 
        data: { "show-password-target": "passwordField" } %>
          <button type="button" data-action="click->show-password#toggle" class="toggle-password">
            </button>
        </div>
      </div>
      
      <% if !resource.provider.present? %>
        <hr>
        <div class="field">
          <%= f.label :current_password, t('edit_profile.current_password') %>
          <i><%= t('edit_profile.current_password_hint') %></i>
          <div class="password-container" data-controller="show-password">
            <%= f.password_field :current_password, 
        autocomplete: "current-password", 
        id: "password-field-3", 
        data: { "show-password-target": "passwordField" } %>
            <button type="button" data-action="click->show-password#toggle" class="toggle-password">
              </button>
          </div>
        </div>
      <%end%>
      
      <div class="field rgpd" style="flex-direction: row; gap: 10px;">
          <%= f.check_box :newsletter, class: "checkbox-input", id: "user_newsletter" %>
          <%= f.label :newsletter, "Je souhaite recevoir les actualit√©s et nouveaut√©s d'Omniscient Design", style: "margin: 0; cursor: pointer;", for: "user_newsletter" %>
      </div>
      <div class="actions">
        <%= f.submit  t('edit_profile.update_button'), class: "button large maj dark" %>
      </div>
    </div>
  <% end %>

  <div style="display:flex" data-controller="popup">
    <button type="button" class="button delete delete-account" data-action="click->popup#open">
      <%= t('edit_profile.delete_account') %>
    </button>
    <div class="modal-overlay" data-popup-target="modal" data-action="click->popup#backgroundClick" style="display: none;">
      <div class="modal-content profil">
        <h3>Nous sommes tristes de vous voir partir üò¢</h3>
        <p>Pourriez-vous nous dire pourquoi vous supprimez votre compte ? Cela nous aide √† nous am√©liorer.</p>
        <%= form_with(url: registration_path(resource_name), method: :delete, local: true, data: { turbo: false }) do |f| %>
          <div class="field">
            <%= f.label :delete_reason, "Raison du d√©part (optionnel)", style: "margin-bottom: 8px; display: block;" %>
            <%= f.text_area :delete_reason, rows: 4, class: "form-control", placeholder: "J'ai trouv√© une meilleure alternative, je ne l'utilise plus..." %>
          </div>
          <div class="modal-actions">
            <button type="button" class="button dark" data-action="click->popup#close">Annuler</button>
            <%= f.submit "Confirmer la suppression d√©finitive", class: "button delete large" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</section>