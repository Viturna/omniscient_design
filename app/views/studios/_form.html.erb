<%# On définit le mode édition %>
<% is_edit_mode = @studio.persisted? %>

<%# Wrapper principal qui connecte le contrôleur Stimulus %>
<%# check-url-value est optionnel. Si vous n'avez pas de vérification d'existence pour les studios, laissez-le vide ou retirez l'attribut %>
<div data-controller="multi-step-form" 
     data-multi-step-form-edit-mode-value="<%= is_edit_mode %>"
     data-multi-step-form-check-url-value="/studios/check_existence">

  <style>
    /* Styles pour les champs imbriqués (designers) */
    .nested-fields-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 colonnes */
      gap: 24px;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .nested-field-group {
      padding: 16px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fdfdfd;
    }
    .date-fields-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .remove-field { /* Pour le formulaire 'edit' */
      margin-top: 10px;
      font-size: 0.9rem;
      color: #E61818;
    }
    .remove-field label {
      color: #E61818 !important;
    }
  </style>

  <%= form_with(model: @studio, local: true, id: "studio-form", data: { controller: "recaptcha", recaptcha_target: "form" }) do |form| %>
    
    <%= hidden_field_tag :recaptcha_token, nil, id: "recaptcha_token", data: { recaptcha_target: "token" } %>
    
    <%# Cible pour les erreurs JS du contrôleur %>
    <div class="error-message" style="color: red; display: none;" data-multi-step-form-target="errorMessage"></div>

    <% if @studio.errors.any? %>
      <div style="color: red">
        <h2><%= t('add_studio.errors.count', count: @studio.errors.count, default: "Erreurs : #{@studio.errors.count}") %></h2>
        <ul>
          <% @studio.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-step" data-multi-step-form-target="step" style="<%= is_edit_mode ? 'display: none;' : 'display: block;' %>">
      <h3>Critères d’acceptation des studios</h3>
      <p>
        Afin de garantir la qualité, la cohérence et le respect du travail de chacun, toute soumission sur omniscientdesign.fr doit respecter les critères suivants.
        <br><br>
        <span style="font-weight:500;">⚠️ Le non-respect de ces règles entraînera la suppression immédiate du contenu et le bannissement définitif du compte. Aucune seconde chance ne sera accordée.</span>
      </p>
      <hr class="rules-add-hr">
      
      <h4>1. Originalité et Authenticité</h4>
      <ul>
        <li>Chaque référence doit être <strong>originale</strong>.</li>
        <li>Chaque référence doit être clairement sourcée.</li>
      </ul>
      <h4>2. Qualité visuelle</h4>
      <ul>
        <li>Images <strong>nettes</strong> et en <strong>haute résolution</strong>.</li>
        <li>Formats acceptés : PNG, JPG, WEBP.</li>
      </ul>
      <h4>3. Respect des droits d’auteur</h4>
      <ul>
        <li>Vous devez avoir les <strong>droits d’utilisation complets</strong> sur tous les éléments partagés.</li>
      </ul>
      <h4>4. Description détaillée</h4>
      <ul>
        <li>Fournir des descriptions complètes.</li>
        <li>Le texte doit être rédigé correctement, <strong>sans fautes d’orthographe</strong> majeures.</li>
        <li>Les descriptions doivent être <strong>factuelles</strong> et <strong>neutres</strong>.</li>
      </ul>
      <h4>5. Pertinence et cohérence</h4>
      <ul>
        <li>Doit être pertinent pour la communauté.</li>
      </ul>
      
      <div style="margin-top:48px;">
        <label style="font-weight: 500; cursor: pointer;">
          <input type="checkbox" 
                 id="accept-rules-checkbox" 
                 data-multi-step-form-target="rulesCheckbox"
                 data-action="change->multi-step-form#toggleRules">
          J’ai lu et j’accepte le règlement ci-dessus
        </label>
      </div>
      
      <div class="flex-btn-add" style="justify-content:flex-end; margin-top:1rem;">
        <button type="button" 
                class="button large" 
                disabled 
                data-multi-step-form-target="rulesNextBtn"
                data-action="click->multi-step-form#next">
          <%= t('add_designer.buttons.next', default: "Suivant") %>
        </button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="<%= is_edit_mode ? 'display: block;' : 'display: none;' %>">
      <h3>Informations générales</h3>
      <div class="flex-form">
        <div style="width: 100%;">
          <%= form.label :nom, t('add_studio.steps.1.nom', default: "Nom du studio") %>
          <%# Target nameInput pour la vérification d'existence %>
          <%= form.text_field :nom, required: true, placeholder: t('add_studio.steps.1.nom_placeholder', default: "Ex: Maison Bonnet, .."), data: { multi_step_form_target: "nameInput" } %>
        </div>
      </div>
      <div class="flex-btn-add" style="justify-content: flex-end;">
        <% unless is_edit_mode %>
          <button type="button" class="prev-step button large" style="margin-right: 10px;" data-action="click->multi-step-form#prev" data-multi-step-form-target="prevButton"><%= t('add_designer.buttons.prev', default: "Précédent") %></button>
        <% end %>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_designer.buttons.next', default: "Suivant") %></button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="display:none;">
      <h3>Designers du studio (10 max)</h3>
      <div class="nested-fields-container">
        <%= form.fields_for :designer_studios do |ds_form| %>
          <div class="nested-field-group">
            <div class="field">
              <%= ds_form.label :designer_id, "Designer" %>
              <%= ds_form.collection_select :designer_id,
                    Designer.where(validation: true).order(:prenom, :nom),
                    :id,
                    :nom_designer, 
                    { prompt: "Sélectionner un designer..." },
                    { class: "form-control designer-select-nested select2" } %>
            </div>
            <div class="date-fields-grid">
              <div class="field">
                <%= ds_form.label :date_entree, "Année d'entrée" %>
                <%= ds_form.number_field :date_entree, placeholder: "Ex: 1990", class: "form-control year-input" %>
              </div>
              <div class="field">
                <%= ds_form.label :date_sortie, "Année de sortie" %>
                <%= ds_form.number_field :date_sortie, placeholder: "Ex: 2005 (ou vide)", class: "form-control year-input" %>
              </div>
            </div>
            <% if ds_form.object.persisted? %>
              <div class="field-checkbox remove-field">
                <%= ds_form.check_box :_destroy %>
                <%= ds_form.label :_destroy, "Supprimer ce designer" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <h3>Dates et Domaines</h3>
      <div class="flex-form">
        <div>
          <%= form.label :date_creation, t('add_studio.steps.2.date_creation', default: "Année de création") %>
          <%= form.text_field :date_creation, required: true, placeholder: "Ex: 1986", class: "year-input", id: "creation-year-input" %>
          <div class="error-message" id="creation-year-error"></div>
        </div>
        <div>
          <%= form.label :date_fin, t('add_studio.steps.2.date_fin', default: "Année de fermeture (optionnel)") %>
          <%= form.text_field :date_fin, placeholder: "Ex: 2023", class: "year-input", id: "end-year-input" %>
          <div class="error-message" id="end-year-error"></div>
        </div>
        <div>
          <%= form.label :country_ids, t('add_designer.steps.2.country', default: "Pays") %>
          <%= form.collection_select :country_ids,
              Country.order(:country),
              :id,
              :country,
              { prompt: "Sélectionner un ou plusieurs pays", selected: @studio.country_ids },
              { 
                class: "form-control country-select select2", 
                multiple: true, 
                data: { placeholder: "Rechercher un pays..." }
              } %>
        </div>
        <div>
          <%= form.label :domaine_ids, t('add_oeuvre.steps.2.domaine_id', default: "Domaines") %>
          <%= form.collection_select :domaine_ids, 
              Domaine.order(:domaine), 
              :id, 
              :domaine, 
              { include_blank: false, selected: @studio.domaine_ids }, 
              { class: "form-control domaine-select", multiple: true, name: "studio[domaine_ids][]" } %>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_designer.buttons.prev', default: "Précédent") %></button>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_designer.buttons.next', default: "Suivant") %></button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="display:none;">
      <h3>Détails et Sources</h3>
      <div class="flex-form">
        <% [:presentation_generale, :formation_et_influences, :style_ou_philosophie, :creations_majeures, :heritage_et_impact].each do |field| %>
          <div>
            <%= form.label field, t("add_studio.steps.3.#{field}", default: field.to_s.humanize) %>
            <%# Seule la présentation générale est souvent obligatoire, adaptez required si besoin %>
            <%= form.text_area field, required: (field == :presentation_generale), placeholder: t("add_studio.steps.3.#{field}_placeholder", default: "Renseignez ce champ...") %>
          </div>
        <% end %>
        
        <div data-controller="sources" data-sources-prefix-value="studio">
          <%= form.label :source, t('add_oeuvre.steps.3.source', default: "Sources") %>
          <div data-sources-target="container">
            <% (@studio.source || []).each do |src| %>
              <div class="source-input">
                <%= text_field_tag "studio[source][]", src, placeholder: "https://..." %>
                <button type="button" class="remove-source button small">×</button>
              </div>
            <% end %>
            <% if (@studio.source || []).empty? %>
               <div class="source-input">
                <%= text_field_tag "studio[source][]", "", placeholder: "https://..." %>
                <button type="button" class="remove-source button small">×</button>
              </div>
            <% end %>
          </div>
          <button type="button" data-sources-target="addButton" class="button small">
            <%= t('add_oeuvre.steps.3.add_source_button', default: "Ajouter une autre source") %>
          </button>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_designer.buttons.prev', default: "Précédent") %></button>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_designer.buttons.next', default: "Suivant") %></button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="display:none;">
      <h3><%= t('add_studio.steps.4.title', default: "Images") %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :images, "#{t('add_studio.steps.4.image', default: 'Ajouter des images')} (3 max - Glissez pour réorganiser)" %>
          <div id="image-fields-container" 
               class="image-grid-container"
               data-controller="sortable">
            <%= form.fields_for :studio_images, @studio.studio_images.sort_by { |img| img.position || 0 } do |image_form| %>
              <% next if image_form.index >= 3 %>
              <div class="image-upload-card" 
                   data-controller="image-preview" 
                   data-sortable-target="item">
                <%= image_form.hidden_field :position, data: { 'sortable-target': 'positionInput' } %>
                <div class="image-drag-handle">
                  ⬍ Glisser (Position <%= image_form.object.position || 'N/A' %>)
                </div>
                <% if image_form.object.persisted? && image_form.object.file.attached? %>
                  <div class="image-preview-existing">
                    <%= image_tag image_form.object.file, class: "image-preview-img" %>
                    <div class="image-delete-overlay">
                      <%= image_form.check_box :_destroy %>
                      <%= image_form.label :_destroy, "×", class: "delete-image-btn", title: "Supprimer" %>
                    </div>
                  </div>
                  <div>
                    <div data-image-preview-target="container"></div>
                    <%= image_form.file_field :file, 
                      accept: "image/png,image/jpeg,image/jpg,image/webp",
                      data: { 
                        action: "change->image-preview#preview",
                        image_preview_target: "input" 
                      } %>
                    <%= image_form.text_field :credit, placeholder: "Crédit photo", class: "image-credit-field" %>
                  </div>
                <% else %>
                  <div class="image-preview-new" data-image-preview-target="container"></div>
                  <div style="flex-grow: 1;">
                    <%= image_form.file_field :file, 
                      accept: "image/png,image/jpeg,image/jpg,image/webp",
                      data: { 
                        action: "change->image-preview#preview",
                        image_preview_target: "input" 
                      } %>
                    <%= image_form.text_field :credit, placeholder: "Crédit photo", class: "image-credit-field" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_designer.buttons.prev', default: "Précédent") %></button>
        <%= form.submit t('add_designer.buttons.submit', default: "Soumettre"), class: "button large" %>
      </div>
    </div>

  <% end %>
</div>

<script>
  document.addEventListener("turbo:load", () => {
    // Validation Dates Création/Fermeture
    var creationYearInput = document.getElementById("creation-year-input");
    var endYearInput = document.getElementById("end-year-input");
    var creationYearError = document.getElementById("creation-year-error");
    var endYearError = document.getElementById("end-year-error");
    var currentYear = new Date().getFullYear();

    if (creationYearInput) {
      function validateYear(year) { return !isNaN(year) && year >= 1000 && year <= currentYear; }

      creationYearInput.addEventListener("input", function() {
        if (!validateYear(this.value)) {
          creationYearError.textContent = "Année invalide.";
        } else {
          creationYearError.textContent = "";
        }
      });

      if(endYearInput) {
        endYearInput.addEventListener("input", function() {
          if (this.value && !validateYear(this.value)) {
            endYearError.textContent = "Année invalide.";
          } else {
            if(endYearError) endYearError.textContent = "";
          }
        });
      }
    }

    // Init Select2
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('.designer-select-nested').select2({ placeholder: 'Sélectionner un designer...', allowClear: true, width: '100%'});
        $('.country-select').select2({ placeholder: 'Rechercher un pays...', allowClear: true, width: '100%' });
        $('.domaine-select').select2({ placeholder: 'Sélectionnez un domaine...', allowClear: true, width: '100%' });
    }
  });
</script>

<% content_for :recaptcha_script do %>
  <script src="https://www.google.com/recaptcha/api.js?render=<%= ENV["RECAPTCHA_SITE_KEY"] %>"></script>
<% end %>