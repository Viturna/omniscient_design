<% content_for :title, "DÃ©couvrez des designers inspirants - Omniscient Design" %>
<% content_for :description, "Plongez dans notre sÃ©lection de designers : biographies, projets, styles et parcours rÃ©unis dans un carnet numÃ©rique unique." %>
<style>
  @media screen and (max-width: 320px) {
    .top-bar-search {
      display: none;
    }
    #cardContainer {
      height: calc(100dvh - 50px); /* Ajuster la hauteur pour les petits Ã©crans */
    }
  }
   #cardContainer {
    position: relative;
    height: 100dvh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
  }
  .box-card{
    display: flex;
    flex-direction: column;
  }

  body {
    margin: 0;
    overflow: hidden; /* DÃ©sactive le scroll global */
  }
</style>
<section class="home-page top-bar-search">
  <%= link_to search_path, class: "search-link" do %>
    <input id="workSearch" name="query" autocomplete="off" class="search-top-bar" type="search" placeholder="<%= t('search.placeholder') %>">
  <% end %>
  <div class="top-bar-flex">
    <div class="circle circle-notif openPopup" id="openPopup">
      <svg width="4" height="22" viewBox="0 0 4 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 8L2 20" stroke="white" stroke-width="2.82843" stroke-linecap="round"/>
        <path d="M2 2V2.0001" stroke="white" stroke-width="2.82843" stroke-linecap="round"/>
      </svg>
      <div class="notification-counter">
        <div class="notification-badge">!</div>
      </div>
    </div>
    <%= link_to notifications_path do %>
      <div class="circle circle-notif">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20.1825 5.26C19.3238 4.76133 18.7932 3.83333 18.7945 2.83333V2.82933C18.7958 1.26667 17.5438 0 15.9998 0C14.4558 0 13.2038 1.26667 13.2038 2.82933V2.83333C13.2052 3.83467 12.6758 4.76133 11.8158 5.26C5.59317 8.876 9.16917 20.88 2.6665 23.0013V25.3333H29.3332V23.0013C22.8305 20.88 26.4065 8.876 20.1825 5.26ZM15.9998 1.33333C16.7358 1.33333 17.3332 1.932 17.3332 2.66667C17.3332 3.40267 16.7358 4 15.9998 4C15.2638 4 14.6665 3.40267 14.6665 2.66667C14.6665 1.932 15.2638 1.33333 15.9998 1.33333ZM19.9998 28C19.9998 30.1307 18.1438 32 16.0385 32C13.9332 32 11.9998 30.1307 11.9998 28H19.9998Z" fill="white"/>
        </svg>
        <% if current_user %>
          <% if @unread_notifications_count > 0 %>
            <div class="notification-counter">
              <div class="notification-badge"><%= @unread_notifications_count %></div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <%# <button data-controller="lang-switcher" class="lang-switcher" data-action="click->lang-switcher#toggle">
    <span class="lang-icon">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8.82263 6.50977C8.82263 10.8194 6.63857 12.9761 3.94531 12.9761M3.94531 6.50977H10.7736" stroke="white" stroke-width="1.95093" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4.9209 9.07349C4.9209 11.1649 7.11764 12.8856 10.7737 12.9753M11.7491 19.8036L15.651 11.0244L19.5529 19.8036M18.6749 17.8527H12.6271M6.57333 3.2207L7.34688 3.78842" stroke="white" stroke-width="1.95093" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
      </span>
      <span class="lang-label" data-lang-switcher-target="current"><%= I18n.locale.to_s.upcase </span>
      <span class="lang-arrow">
    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4.83984 6.80664L9.22632 11.1931L13.6128 6.80664" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
      </span>
      <div class="lang-dropdown" data-lang-switcher-target="dropdown">
          <%= link_to url_for(locale: :fr), class: "lang-option", data: { action: "click->lang-switcher#select", lang_switcher_target: "option", lang: "FR" } do 
            <span class="flag">ðŸ‡«ðŸ‡·</span> FR
          <% end 
          <%= link_to url_for(locale: :en), class: "lang-option", data: { action: "click->lang-switcher#select", lang_switcher_target: "option", lang: "EN" } do 
            <span class="flag">ðŸ‡¬ðŸ‡§</span> EN
          <% end 
      </div>
  </button> %>
  </div>
</section>
<div id="designers">
  <div class="home-flex" id="cardContainer">
    <div class="nav-home-mobile">
      <%= image_tag("logo.svg", alt: "Logo", class: "logo-img") %>
      <div class="switch-home-mobile">
        <%= link_to t('global.designers'), designers_path, class: "active"  %>
        <%= link_to t('global.references'), oeuvres_path%>
      </div>
      <div class="circle circle-notif openPopup" id="openPopup">
        <svg width="2" height="11" viewBox="0 0 4 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2 8L2 20" stroke="white" stroke-width="2.82843" stroke-linecap="round"/>
          <path d="M2 2V2.0001" stroke="white" stroke-width="2.82843" stroke-linecap="round"/>
        </svg>
      </div>
    </div>
    <div class="switch-home">
      <%= link_to t('global.designers'), designers_path, class: "active" %>
      <%= link_to t('global.references'), oeuvres_path %>
    </div>
    <%# <div class="refonte-alert" id="refonteAlert">
      <div class="refonte-alert-content">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 1l-12 22h24l-12-22zm-1 8h2v7h-2v-7zm1 11.25c-.69 0-1.25-.56-1.25-1.25s.56-1.25 1.25-1.25 1.25.56 1.25 1.25-.56 1.25-1.25 1.25z"/></svg>
        <span><strong>Maintenance :</strong> Une opÃ©ration de refonte des images est en cours sur les designers. Elles reviennent bientÃ´t !</span>
      </div>
      <button class="refonte-alert-close" id="closeRefonteAlert" title="Fermer">Ã—</button>
    </div> %>
    <div class="box-card" id="boxCard">
      <% @items.each do |item| %>
        <% if item.is_a?(Designer) %>
          <%= render partial: 'designers/card', locals: { card: item, class_name: 'card' } %>
        <% elsif item.is_a?(Hash) %>
          <%= render partial: 'oeuvres/ad_card', locals: { ad: item } %>
        <% end %>
      <% end %>
    </div>
    <div id="designers-load-more" 
         data-offset="<%= @items.count { |i| i.is_a?(Designer) } %>"
         data-loaded-ids="<%= @items.select { |i| i.is_a?(Designer) }.map(&:id).join(',') %>"
         data-ad-index="0"
         data-items-until-next-ad="<%= @items_until_next_ad %>"
         data-ads-order="<%= @ads_order_string %>">
    </div>
    <div class="button-nav">
      <button class="arrow-button up">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 38L18 40L22 40L22 38L18 38ZM22 6C22 4.89543 21.1046 4 20 4C18.8954 4 18 4.89543 18 6L22 6ZM22 38L22 6L18 6L18 38L22 38Z" fill="white"/>
          <path d="M5 15.8408L20.0002 2.54515L35.0005 15.8408" stroke="white" stroke-width="3.65112" stroke-linecap="square"/>
        </svg>
      </button>
      <button class="arrow-button down">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 2L18 1.86484e-08L22 -1.86484e-08L22 2L18 2ZM22 34C22 35.1046 21.1046 36 20 36C18.8954 36 18 35.1046 18 34L22 34ZM22 2L22 34L18 34L18 2L22 2Z" fill="white"/>
          <path d="M5 24.1592L20.0002 37.4549L35.0005 24.1592" stroke="white" stroke-width="3.65112" stroke-linecap="square"/>
        </svg>
      </button>
    </div>
  </div>
  <script>
    document.addEventListener("turbo:load", () => {
      const container = document.getElementById("cardContainer");
      if (container) {
        container.scrollTop = 0;
      }
      const loadMoreTrigger = document.getElementById("designers-load-more");
      const upButton = document.querySelector(".arrow-button.up");
      const downButton = document.querySelector(".arrow-button.down");

      if (!container || !loadMoreTrigger) return;

      let isLoading = false;
      let isScrolling = false;

      // --- SCROLL INFINI (MIS Ã€ JOUR POUR JSON + PUBS) ---
      function loadMoreCards() {
        if (isLoading) return;
        isLoading = true;

        // RÃ©cupÃ¨re les donnÃ©es actuelles depuis les attributs data-*
        let offset = parseInt(loadMoreTrigger.dataset.offset) || 0;
        let loadedIds = loadMoreTrigger.dataset.loadedIds || '';
        let itemsUntilNextAd = loadMoreTrigger.dataset.itemsUntilNextAd;
        let adIndex = loadMoreTrigger.dataset.adIndex;
        let adsOrder = loadMoreTrigger.dataset.adsOrder; // RÃ©cupÃ¨re l'ordre

        // Construit l'URL avec tous les paramÃ¨tres
        const url = `/designers/load_more?offset=${offset}&loaded_ids=${loadedIds}&items_until_next_ad=${itemsUntilNextAd}&ad_index=${adIndex}&ads_order=${adsOrder}`;

        fetch(url, {
          headers: {
            'Accept': 'application/json' // Important : on attend du JSON
          }
        })
        .then(response => response.json()) // On parse la rÃ©ponse JSON
        .then(data => {
          if (data.html.trim() === "") {
            loadMoreTrigger.style.display = "none"; // Plus rien Ã  charger
          } else {
            // InsÃ¨re le nouveau HTML (qui contient designers ET pubs)
            container.querySelector('#boxCard').insertAdjacentHTML("beforeend", data.html);

            // Met Ã  jour les compteurs sur le trigger pour le prochain appel
            loadMoreTrigger.dataset.itemsUntilNextAd = data.items_until_next_ad;
            loadMoreTrigger.dataset.adIndex = data.ad_index;

            // Met Ã  jour l'offset et les IDs chargÃ©s
            const currentCards = Array.from(container.querySelectorAll('.card:not(.ad-card)'));
            const allLoadedIds = currentCards.map(c => c.dataset.id).filter(id => id);

            loadMoreTrigger.dataset.offset = allLoadedIds.length;
            loadMoreTrigger.dataset.loadedIds = allLoadedIds.join(',');

            validateCardAlignment();
          }
        })
        .catch((err) => {
          console.error("Erreur lors du chargement des cartes :", err);
        })
        .finally(() => {
          isLoading = false;
        });
      }

      function validateCardAlignment() {
        container.querySelectorAll(".card, .ad-card").forEach((card) => {
          card.style.marginBottom = "10px";
        });
      }

      // --- NAVIGATION VERTICALE (Boutons, Clavier) ---
      function scrollToCard(direction) {
        const cards = Array.from(container.querySelectorAll(".card, .ad-card")); // Inclut les pubs
        const scrollTop = container.scrollTop;
        const containerHeight = container.clientHeight;

        const currentIndex = cards.findIndex(card => {
          const cardTop = card.offsetTop;
          const cardBottom = cardTop + card.offsetHeight;
          return cardTop <= scrollTop + containerHeight / 2 && cardBottom >= scrollTop + containerHeight / 2;
        });

        let targetIndex = currentIndex;
        if (direction === "down" && currentIndex < cards.length - 1) {
          targetIndex++;
        } else if (direction === "up" && currentIndex > 0) {
          targetIndex--;
        }

        if (targetIndex !== currentIndex) {
          cards[targetIndex].scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      if (upButton && downButton) {
        upButton.addEventListener("click", () => scrollToCard("up"));
        downButton.addEventListener("click", () => scrollToCard("down"));
      }
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowUp") scrollToCard("up");
        if (e.key === "ArrowDown") scrollToCard("down");
      });

      // --- GESTION UNIFIÃ‰E DES TOUCHES (Vertical + Horizontal) ---
      let touchStartX = 0;
      let touchStartY = 0;

      container.addEventListener("touchstart", (e) => {
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].screenX; // Ajout pour swipe horizontal
      }, { passive: true });

      container.addEventListener("touchend", (e) => {
        if (isScrolling) return;

        touchEndY = e.changedTouches[0].clientY;
        const touchEndX = e.changedTouches[0].screenX;
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // Si mouvement horizontal dominant -> Navigation entre pages
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
           // Swipe GAUCHE -> aller vers Oeuvres
           if (deltaX < 0) {
               window.location.href = '<%= oeuvres_path %>';
           }
        }
        // Sinon si mouvement vertical dominant -> Navigation entre cartes
        else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 50) {
           if (deltaY > 0) scrollToCard("up"); // Swipe vers le bas
           else scrollToCard("down"); // Swipe vers le haut
        }
      }, { passive: true });


      validateCardAlignment();

      // Ã‰couteur de dÃ©filement pour le chargement infini
      container.addEventListener("scroll", () => {
        const { scrollTop, scrollHeight, clientHeight } = container;
        isScrolling = true;

        if (!isLoading && scrollTop + clientHeight >= scrollHeight - 300) {
          loadMoreCards();
        }

        setTimeout(() => (isScrolling = false), 100);
      }, { passive: true });
    });
  </script>
  <div id="popup" class="popup">
    <div class="popup-content">
      <div class="top-popup">
        <svg class="close-popup" id="closePopup" width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19.9941 16.9964L33.3719 3.63981C33.7717 3.23995 33.9964 2.69763 33.9964 2.13215C33.9964 1.56667 33.7717 1.02435 33.3719 0.624492C32.972 0.224637 32.4297 0 31.8642 0C31.2987 0 30.7564 0.224637 30.3566 0.624492L17 14.0023L3.64343 0.624492C3.24358 0.224637 2.70125 5.02059e-07 2.13577 5.06273e-07C1.57029 5.10486e-07 1.02797 0.224637 0.628116 0.624492C0.228261 1.02435 0.00362441 1.56667 0.00362441 2.13215C0.0036244 2.69763 0.228261 3.23995 0.628116 3.63981L14.0059 16.9964L0.628116 30.3529C0.429087 30.5504 0.271115 30.7852 0.163309 31.044C0.055504 31.3027 0 31.5803 0 31.8606C0 32.1409 0.055504 32.4185 0.163309 32.6772C0.271115 32.936 0.429087 33.1709 0.628116 33.3683C0.825519 33.5673 1.06038 33.7253 1.31914 33.8331C1.5779 33.9409 1.85545 33.9964 2.13577 33.9964C2.4161 33.9964 2.69364 33.9409 2.95241 33.8331C3.21117 33.7253 3.44603 33.5673 3.64343 33.3683L17 19.9905L30.3566 33.3683C30.554 33.5673 30.7888 33.7253 31.0476 33.8331C31.3064 33.9409 31.5839 33.9964 31.8642 33.9964C32.1445 33.9964 32.4221 33.9409 32.6809 33.8331C32.9396 33.7253 33.1745 33.5673 33.3719 33.3683C33.5709 33.1709 33.7289 32.936 33.8367 32.6772C33.9445 32.4185 34 32.1409 34 31.8606C34 31.5803 33.9445 31.3027 33.8367 31.044C33.7289 30.7852 33.5709 30.5504 33.3719 30.3529L19.9941 16.9964Z" fill="#202020"/>
        </svg>
      </div>
      <div class="popup-inner">
        <p class="title-popup"><%= t('mainpopup.title') %></p>
        <div class="popup-decoration">
          <%= image_tag("merci-100.png", :alt => "100 utilisateurs") %>
        </div>
        <p class="subtitle-popup">Un grand merci</p>
        <p>
          La communautÃ© Omniscient Design s'agrandit ! Nous sommes incroyablement fiers et reconnaissants de compter aujourd'hui <strong>plus de 100 utilisateurs inscrits</strong>. Merci Ã  chacun de vous !
          <br>
          <br>
          Nous souhaitons adresser un immense merci tout particulier Ã  <strong>Lou, notre toute premiÃ¨re donatrice</strong> ! ðŸ’–
          <br>
          <br>
          Un geste formidable qui nous aide concrÃ¨tement Ã  maintenir la plateforme active et Ã  financer son dÃ©veloppement futur. 
          <br>
          <br>
          Mais sa contribution ne s'arrÃªte pas lÃ  : Lou a aussi enrichi la base de donnÃ©es en ajoutant la fiche du designer 
          <%= link_to "Jean Widmer", "https://omniscientdesign.fr/fr/designers/jean-widmer", style: "text-decoration: underline; font-weight: 500; color: #202020;" %>.
          <br>
          <br>
          C'est exactement l'esprit que nous souhaitons pour Omniscient Design : une plateforme collaborative qui vit et s'enrichit grÃ¢ce Ã  sa communautÃ©.
          <br>
          <br>
          Si vous aussi, vous apprÃ©ciez le projet, vous pouvez faire comme Lou !
        </p>
        <%= link_to "Faire un don", "https://fr.tipeee.com/le-site-omniscient-design", class: "button dark"%>
        <%= link_to "Ajouter une rÃ©fÃ©rence", add_elements_path, class: "button dark" %>
        <div class="popup-decoration">
          <%= image_tag("logo-white.svg", :alt => "logo omniscient design") %>
        </div>
        <p class="subtitle-popup"><%= t('mainpopup.subtitle_project') %></p>
        <p><%= t('mainpopup.description_project').gsub("\n", "<br>").html_safe %></p>
        <%= link_to presentation_url, class: "button dark" do %>
          <%= t('mainpopup.button_project') %>
        <%end%>
        <div class="popup-decoration">
          <svg width="186" height="46" viewBox="0 0 186 46" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_3317_340)">
              <path d="M23 0L30.0303 15.6304L46 17.8365L34.3773 29.0068L37.214 46L23 37.2715L8.78408 46L11.6227 29.0068L0 17.8365L15.9697 15.6304L23 0Z" fill="white"/>
            </g>
            <g clip-path="url(#clip1_3317_340)">
              <path d="M93 0L100.03 15.6304L116 17.8365L104.377 29.0068L107.214 46L93 37.2715L78.7841 46L81.6227 29.0068L70 17.8365L85.9697 15.6304L93 0Z" fill="white"/>
            </g>
            <g clip-path="url(#clip2_3317_340)">
              <path d="M163 0L170.03 15.6304L186 17.8365L174.377 29.0068L177.214 46L163 37.2715L148.784 46L151.623 29.0068L140 17.8365L155.97 15.6304L163 0Z" fill="white"/>
            </g>
            <defs>
              <clipPath id="clip0_3317_340">
                <rect width="46" height="46" fill="white"/>
              </clipPath>
              <clipPath id="clip1_3317_340">
                <rect width="46" height="46" fill="white" transform="translate(70)"/>
              </clipPath>
              <clipPath id="clip2_3317_340">
                <rect width="46" height="46" fill="white" transform="translate(140)"/>
              </clipPath>
            </defs>
          </svg>
        </div>
        <p class="subtitle-popup"><%= t('mainpopup.subtitle_feedback') %></p>
        <p><%= t('mainpopup.description_feedback') %></p>
        <%= link_to new_feedback_url, class: "button dark" do %>
          <%= t('mainpopup.button_feedback') %>
        <%end%>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("turbo:load", function() {
      const alertElement = document.getElementById("refonteAlert");
      const closeButton = document.getElementById("closeRefonteAlert");

      // S'ils n'existent pas sur la page, on ne fait rien
      if (!alertElement || !closeButton) return;

      closeButton.addEventListener("click", function() {
        alertElement.style.display = "none";
      });
    });
  </script>
  <script>
    document.addEventListener("turbo:load", function() {
      // SÃ©lectionner TOUS les Ã©lÃ©ments avec la classe .openPopup
      const openPopupBtns = document.querySelectorAll(".openPopup");
      const closePopupButton = document.getElementById("closePopup");
      const popup = document.getElementById("popup");

      if (!closePopupButton || !popup) return;

      // Boucle sur tous les boutons d'ouverture pour leur ajouter l'Ã©couteur d'Ã©vÃ©nement
      openPopupBtns.forEach(btn => {
        btn.addEventListener("click", function() {
          popup.style.display = "flex";
        });
      });

      closePopupButton.addEventListener("click", function() {
        popup.style.display = "none";
      });

      window.addEventListener("click", function(event) {
        if (event.target === popup) {
          popup.style.display = "none";
        }
      });
    });
  </script>