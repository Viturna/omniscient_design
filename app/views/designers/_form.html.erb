<% is_edit_mode = @designer.persisted? %>
<div data-controller="multi-step-form" 
     data-multi-step-form-edit-mode-value="<%= is_edit_mode %>"
     data-multi-step-form-check-url-value="/designers/check_existence"
     data-multi-step-form-form-type-value="designer">
  <%= form_with(model: @designer, local: true, id: "designer-form", data: { controller: "recaptcha", recaptcha_target: "form" }) do |form| %>
    <%= hidden_field_tag :recaptcha_token, nil, id: "recaptcha_token", data: { recaptcha_target: "token" } %>
    <div class="error-message" style="color: red; display: none;" data-multi-step-form-target="errorMessage"></div>
    <% if @designer.errors.any? %>
      <div style="color: red; margin-bottom: 20px;">
        <h2><%= t('add_designer.errors.count', count: @designer.errors.count) %></h2>
        <ul>
          <% @designer.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <div class="form-step" data-multi-step-form-target="step" style="<%= is_edit_mode ? 'display: none;' : 'display: block;' %>">
      <h3>Critères d’acceptation des références et designers</h3>
      <p>
        Afin de garantir la qualité, la cohérence et le respect du travail de chacun, toute soumission sur omniscientdesign.fr doit respecter les critères suivants.
        <br>
        <br>
        <span style="font-weight:500;">⚠️ Le non-respect de ces règles entraînera la suppression immédiate du contenu et le bannissement définitif du compte.</span>
      </p>
      <hr class="rules-add-hr">
      <h4>1. Originalité et Authenticité</h4>
      <ul>
        <li>Chaque référence doit être <strong>originale</strong>.</li>
      </ul>
      <h4>2. Qualité visuelle</h4>
      <ul>
        <li>Images <strong>nettes</strong> et en haute résolution.</li>
      </ul>
      <h4>3. Respect des droits d’auteur</h4>
      <ul>
        <li>Vous devez avoir les droits d’utilisation complets.</li>
      </ul>
      <h4>4. Description détaillée</h4>
      <ul>
        <li>Textes sans fautes et factuels.</li>
      </ul>
      <h4>5. Pertinence</h4>
      <ul>
        <li>Contenu pertinent pour la communauté.</li>
      </ul>
      <h4>6. Contenu responsable</h4>
      <ul>
        <li>Pas de contenu discriminatoire ou politique.</li>
      </ul>
      <p>Soumettre une référence signifie que vous acceptez pleinement ces conditions.</p>
      <div style="margin-top:48px;">
        <label style="font-weight: 500; cursor: pointer;">
          <input type="checkbox" 
                 id="accept-rules-checkbox" 
                 data-multi-step-form-target="rulesCheckbox"
                 data-action="change->multi-step-form#toggleRules">
          J’ai lu et j’accepte le règlement ci-dessus
        </label>
      </div>
      <div class="flex-btn-add" style="justify-content:flex-end; margin-top:1rem;">
        <button type="button" class="next-step button large" id="btn-next-rules" disabled data-multi-step-form-target="rulesNextBtn" data-action="click->multi-step-form#next">
          <%= t('add_oeuvre.buttons.next') %>
        </button>
      </div>
    </div>
    <div class="form-step" data-multi-step-form-target="step" style="<%= is_edit_mode ? 'display: block;' : 'display: none;' %>">
      <h3><%= t('add_designer.steps.1.title') %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :prenom, t('add_designer.steps.1.prenom') %>
          <%= form.text_field :prenom, placeholder: t('add_designer.steps.1.prenom_placeholder'), data: { multi_step_form_target: "surnameInput" } %>
        </div>
        <div>
          <%= form.label :nom, t('add_designer.steps.1.nom') %>
          <%= form.text_field :nom, required: true, placeholder: t('add_designer.steps.1.nom_placeholder'), data: { multi_step_form_target: "nameInput" } %>
        </div>
      </div>
      <div class="flex-btn-add" style="justify-content: flex-end;">
        <% unless is_edit_mode %>
          <button type="button" class="prev-step button large" style="margin-right: 10px;" data-action="click->multi-step-form#prev" data-multi-step-form-target="prevButton"><%= t('add_designer.buttons.prev') %></button>
        <% end %>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_designer.buttons.next') %></button>
      </div>
    </div>
    <div class="form-step" data-multi-step-form-target="step" style="display:none;">
      <h3><%= t('add_designer.steps.2.title') %></h3>
      <div class="flex-form" data-controller="year-validator">
        <div>
          <%= form.label :date_naissance, t('add_designer.steps.2.date_naissance') %>
          <%= form.text_field :date_naissance, 
              required: true, 
              placeholder: t('add_designer.steps.2.date_naissance_placeholder'), 
              class: "year-input", 
              id: "birth-year-input",
              data: { 
                action: "input->year-validator#validate",
                year_validator_target: "input"
              } %>
          <div class="error-message" data-year-validator-target="error" data-for="birth-year-input"></div>
        </div>
        <div>
          <%= form.label :date_deces, t('add_designer.steps.2.date_deces') %>
          <%= form.text_field :date_deces, 
              placeholder: t('add_designer.steps.2.date_deces_placeholder'), 
              class: "year-input", 
              id: "death-year-input",
              data: { 
                action: "input->year-validator#validate",
                year_validator_target: "input"
              } %>
          <div class="error-message" data-year-validator-target="error" data-for="death-year-input"></div>
        </div>
        <div>
          <%= form.label :countries, t('add_designer.steps.2.country') %>
          <%= form.collection_select :country_ids,
              Country.order(:country),
              :id,
              :country,
              { prompt: t('add_designer.steps.2.country_placeholder'), selected: @designer.country_ids },
              { 
                class: "form-control select2", 
                multiple: true, 
                data: { 
                  controller: "select2",
                  select2_placeholder_value: t('add_designer.steps.2.country_placeholder') 
                }
              } %>
        </div>
        <div>
          <%= form.label :domaine_ids, t('add_oeuvre.steps.2.domaine_id') %>
          <%= form.collection_select :domaine_ids, 
              Domaine.order(:domaine), 
              :id, 
              :domaine, 
              { include_blank: false, selected: @designer.domaine_ids }, 
              { 
                class: "form-control", 
                multiple: true, 
                name: "designer[domaine_ids][]",
                data: {
                  controller: "select2",
                  select2_placeholder_value: "Sélectionnez un ou plusieurs domaines..."
                }
              } %>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_designer.buttons.prev') %></button>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_designer.buttons.next') %></button>
      </div>
    </div>
    <div class="form-step" data-multi-step-form-target="step" style="display:none;">
      <h3><%= t('add_designer.steps.3.title') %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :presentation_generale, t("add_designer.steps.3.presentation_generale") %>
          <%= form.text_area :presentation_generale, placeholder: t("add_designer.steps.3.presentation_generale_placeholder") %>
        </div>
        <% [:formation_et_influences, :style_ou_philosophie, :creations_majeures, :heritage_et_impact].each do |field| %>
          <div>
            <%= form.label field, t("add_designer.steps.3.#{field}") %>
            <%= form.text_area field, placeholder: t("add_designer.steps.3.#{field}_placeholder") %>
          </div>
        <% end %>
        <div data-controller="sources" data-sources-prefix-value="designer">
          <%= form.label :source, t('add_oeuvre.steps.3.source') %>
          <div data-sources-target="container">
            <% (@designer.source.presence || []).each do |src| %>
              <div class="source-input">
                <%= text_field_tag "designer[source][]", src, placeholder: t('add_oeuvre.steps.3.source_placeholder') %>
                <button type="button" class="remove-source button small">×</button>
              </div>
            <% end %>
            <% if (@designer.source.blank? || @designer.source.empty?) %>
              <div class="source-input">
                <%= text_field_tag "designer[source][]", "", placeholder: t('add_oeuvre.steps.3.source_placeholder') %>
                <button type="button" class="remove-source button small">×</button>
              </div>
            <% end %>
          </div>
          <button type="button" data-sources-target="addButton" class="button small">
            <%= t('add_oeuvre.steps.3.add_source_button') %>
          </button>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_designer.buttons.prev') %></button>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_designer.buttons.next') %></button>
      </div>
    </div>
    <div class="form-step" data-multi-step-form-target="step" style="display: none;">
      <h3><%= t('add_designer.steps.4.title', default: "Images") %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :images, "#{t('add_designer.steps.4.image', default: 'Ajouter des images')} (3 max - Glissez pour réorganiser)" %>
          <div id="image-fields-container" 
             class="image-grid-container"
             data-controller="sortable">
            <%= form.fields_for :designer_images, @designer.designer_images.sort_by { |img| img.position || 0 } do |image_form| %>
              <% next if image_form.index >= 3 %>
              <div class="image-upload-card" 
                 data-controller="image-preview" 
                 data-sortable-target="item">
                <%= image_form.hidden_field :position, data: { 'sortable-target': 'positionInput' } %>
                <div class="image-drag-handle">
                  ⬍ Glisser (Position <%= image_form.object.position || 'N/A' %>)
                </div>
                <% if image_form.object.persisted? && image_form.object.file.attached? %>
                  <div class="image-preview-existing">
                    <%= image_tag image_form.object.file.variant(:thumb), class: "image-preview-img" %>
                    <div class="image-delete-overlay">
                      <%= image_form.check_box :_destroy %>
                      <%= image_form.label :_destroy, "×", class: "delete-image-btn", title: "Supprimer" %>
                    </div>
                  </div>
                  <div>
                    <div data-image-preview-target="container"></div>
                    <%= image_form.file_field :file, 
                    accept: "image/png,image/jpeg,image/jpg,image/webp",
                    data: { 
                      action: "change->image-preview#preview",
                      image_preview_target: "input" 
                    } %>
                    <%= image_form.text_field :credit, placeholder: "Crédit photo", class: "image-credit-field" %>
                  </div>
                <% else %>
                  <div class="image-preview-new" data-image-preview-target="container"></div>
                  <div style="flex-grow: 1;">
                    <%= image_form.file_field :file, 
                    accept: "image/png,image/jpeg,image/jpg,image/webp",
                    data: { 
                      action: "change->image-preview#preview",
                      image_preview_target: "input" 
                    } %>
                    <%= image_form.text_field :credit, placeholder: "Crédit photo", class: "image-credit-field" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_designer.buttons.prev') %></button>
        <%= form.submit t('add_designer.buttons.submit'), class: "button large" %>
      </div>
    </div>
  <% end %>
</div>
<% content_for :recaptcha_script do %>
  <script src="https://www.google.com/recaptcha/api.js?render=<%= ENV["RECAPTCHA_SITE_KEY"] %>"></script>
<% end %>