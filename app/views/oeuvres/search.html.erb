<% content_for :title, "Rechercher des références et des designers - Omniscient Design" %>
<% content_for :description, "La page de recherche permet de trouver efficacement et rapidement la référence que tu cherches. Trie les références par domaine, année ou encore pays !" %>
<section class="top-bar-search">
  <%= form_with url: search_oeuvres_path, method: :get, local: true do |form| %>
    <div class="autocomplete">
      <%= form.search_field :query, class: 'search-top-bar', placeholder: 'Rechercher une référence', autocomplete: 'off', id: 'workSearch', style: "background-image: url('...'); background-repeat: no-repeat; background-position-x: 20px; background-position-y: center;" %>
    </div>
  <% end %>
  <div class="top-bar-flex">
    <%= link_to notifications_path do %>
      <div class="circle circle-notif">
        <svg width="25" height="29" viewBox="0 0 25 29" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M24.8571 23.4762V24.8571H0V23.4762L2.7619 20.7143V12.4286C2.7619 8.14762 5.56524 4.37762 9.66667 3.16238V2.7619C9.66667 2.0294 9.95765 1.3269 10.4756 0.808943C10.9936 0.290985 11.6961 0 12.4286 0C13.1611 0 13.8636 0.290985 14.3815 0.808943C14.8995 1.3269 15.1905 2.0294 15.1905 2.7619V3.16238C19.2919 4.37762 22.0952 8.14762 22.0952 12.4286V20.7143L24.8571 23.4762ZM15.1905 26.2381C15.1905 26.9706 14.8995 27.6731 14.3815 28.1911C13.8636 28.709 13.1611 29 12.4286 29C11.6961 29 10.9936 28.709 10.4756 28.1911C9.95765 27.6731 9.66667 26.9706 9.66667 26.2381" fill="white"/>
        </svg>
        <% if current_user %>
          <% if @unread_notifications_count > 0 %>
            <div class="notification-counter">
              <div class="notification-badge"><%= @unread_notifications_count %></div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <%= link_to new_feedback_url do %>
      <div class="circle circle-notif">
        <svg width="31" height="29" viewBox="0 0 31 29" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19.5185 0C18.9095 0 18.3254 0.24193 17.8948 0.672569C17.4642 1.10321 17.2222 1.68728 17.2222 2.2963V6.88889C17.2222 7.4979 17.4642 8.08198 17.8948 8.51261C18.3254 8.94325 18.9095 9.18518 19.5185 9.18518V12.6296L23.6519 9.18518H28.7037C29.3127 9.18518 29.8968 8.94325 30.3274 8.51261C30.7581 8.08198 31 7.4979 31 6.88889V2.2963C31 1.68728 30.7581 1.10321 30.3274 0.672569C29.8968 0.24193 29.3127 0 28.7037 0H19.5185ZM9.18519 5.74074C7.96715 5.74074 6.79901 6.2246 5.93773 7.08588C5.07645 7.94716 4.59259 9.1153 4.59259 10.3333C4.59259 11.5514 5.07645 12.7195 5.93773 13.5808C6.79901 14.4421 7.96715 14.9259 9.18519 14.9259C10.4032 14.9259 11.5714 14.4421 12.4326 13.5808C13.2939 12.7195 13.7778 11.5514 13.7778 10.3333C13.7778 9.1153 13.2939 7.94716 12.4326 7.08588C11.5714 6.2246 10.4032 5.74074 9.18519 5.74074ZM14.9259 17.2222H3.44444C2.53092 17.2222 1.65481 17.5851 1.00885 18.2311C0.362896 18.877 0 19.7531 0 20.6667C0 23.2293 1.054 25.2822 2.78311 26.6715C4.48467 28.0378 6.76719 28.7037 9.18519 28.7037C11.6032 28.7037 13.8857 28.0378 15.5873 26.6715C17.3141 25.2822 18.3704 23.2293 18.3704 20.6667C18.3704 19.7531 18.0075 18.877 17.3615 18.2311C16.7156 17.5851 15.8394 17.2222 14.9259 17.2222Z" fill="white"/>
        </svg>
      </div>
    <% end %>
  </div>
</section>
<section class="grid-1 searchpage">
  <% if @oeuvre_suggestions.present? || @designer_suggestions.present? %>
    <div class="search-results">
      <%= link_to search_oeuvres_path do %>
        <svg width="26" height="23" viewBox="0 0 26 23" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M25.0002 11.4996L2.00012 11.4996M2.00012 11.4996L10.6252 21.2305M2.00012 11.4996L10.6252 1.76882" stroke="#202020" stroke-width="2" stroke-linecap="square"/>
        </svg>
      <%end%>
      <p class="medium black" style="margin-top: 16px;">Suggestions pour "<%= params[:query] %>"</p>
      <div class="suggestions">
        <% if @oeuvre_suggestions.present? %>
          <p>Références :</p>
          <div class="flex-container">
            <% @oeuvre_suggestions.each do |oeuvre| %>
              <%= render 'oeuvres/oeuvre_card', oeuvre: oeuvre %>
            <% end %>
          </div>
        <% end %>
        <% if @designer_suggestions.present? %>
          <p>Designers :</p>
          <div class="flex-container">
            <% @designer_suggestions.each do |designer| %>
              <%= render 'designers/designer_card', designer: designer %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% elsif params[:query] %>
    <%= link_to search_oeuvres_path do %>
      <svg width="26" height="23" viewBox="0 0 26 23" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M25.0002 11.4996L2.00012 11.4996M2.00012 11.4996L10.6252 21.2305M2.00012 11.4996L10.6252 1.76882" stroke="#202020" stroke-width="2" stroke-linecap="square"/>
      </svg>
    <%end%>
    <p>Aucun résultat trouvé pour "<%= params[:query] %>"</p>
  <%else%>
    <h1>Rechercher</h1>
    <h2 class="title">Catégories</h2>
    <div class="flex-category">
      <% Domaine.all.each do |domaine| %>
        <%= link_to search_category_path(domaine: domaine.id) do %>
          <div class="card-category" style="background-color: <%= domaine.couleur %>80;">
            <%= image_tag "domaines/#{domaine.svg}", alt: domaine.domaine %>
            <p class="text-category" style="color:<%= domaine.couleur %>;"><%= domaine.domaine %></p>
          </div>
        <% end %>
      <% end %>
    </div>
    <h2 class="title">Frise Chronologique</h2>
    <a href="/search_frise">
      <div class="timeline">
        <% @timeline_years.each do |year| %>
          <div class="timeline-item">
            <div class="oeuvres">
              <div class="oeuvres-container">
                <% oeuvres_year = @oeuvres_filtered.select { |oeuvre| oeuvre.date_oeuvre.to_i == year } %>
                <% oeuvres_year.each do |oeuvre| %>
                  <div class="oeuvre" title="<%= oeuvre.nom_oeuvre %>" data-year="<%= oeuvre.date_oeuvre %>" style="background-image: url('<%= oeuvre.image %>');"></div>
                <% end %>
                <% designers_year = @designers_filtered.select { |designer| designer.date_naissance.to_i == year } %>
                <% designers_year.each do |designer| %>
                  <div class="oeuvre" title="<%= designer.nom_designer %>" data-year="<%= designer.date_naissance %>" style="background-image: url('<%= designer.image %>');"></div>
                <% end %>
              </div>
              <div class="oeuvre empty"></div>
              <div class="year"><%= year %></div>
            </div>
          </div>
        <% end %>
        <hr class="timeline-hr">
      </div>
      <button class="button dark">Voir les frises chronologiques</button>
    </a>
    <h2 class="title">Designers</h2>
    <div class="container-designers">
      <div class="flex-container" id="designer-cards">
        <% @designers.first(8).each do |designer| %>
          <%= render 'designers/designer_card', designer: designer %>
        <% end %>
      </div>
      <div id="load-more-button-designers">
        <button class="load-more-btn button dark" id="loadMoreDesignersBtn">Charger plus de designers</button>
      </div>
    </div>
    <h2 class="title">Références</h2>
    <div class="container-oeuvres">
      <div class="flex-container" id="oeuvre-cards">
        <% @oeuvres.first(8).each do |oeuvre| %>
          <%= render 'oeuvres/oeuvre_card', oeuvre: oeuvre %>
        <% end %>
      </div>
      <div id="load-more-button-oeuvres">
        <button class="load-more-btn button dark" id="loadMoreOeuvresBtn">Charger plus de références</button>
      </div>
    </div>
  </div>
<% end %>
</section>
<script>
  document.addEventListener("DOMContentLoaded", function () {
  function loadMore(endpoint, containerId, offset) {
    fetch(`${endpoint}?offset=${offset}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(response => response.text())
      .then(html => {
        document.getElementById(containerId).insertAdjacentHTML("beforeend", html);
      })
      .catch(error => console.error("Erreur lors du chargement :", error));
  }

  let designerOffset = 8;
  let oeuvreOffset = 8;

  document.getElementById("loadMoreDesignersBtn").addEventListener("click", function () {
    loadMore("/designers/load_more_designers", "designer-cards", designerOffset);
    designerOffset += 8;
  });

  document.getElementById("loadMoreOeuvresBtn").addEventListener("click", function () {
    loadMore("/oeuvres/load_more_oeuvres", "oeuvre-cards", oeuvreOffset);
    oeuvreOffset += 8;
  });
  });
</script>
<%= javascript_include_tag "controllers/autocompleteSearch", defer: true %>
<script>
  $(document).ready(function() {
    var works = <%= raw @works.to_json %>; // Injecter les noms des références dans le JavaScript
    var designers = <%= raw @designers.to_json %>; // Injecter les noms des designers dans le JavaScript

    // Mapping des noms vers les URLs respectives
    var routeMap = {
      <% @oeuvres.each do |oeuvre| %>
        "<%= j oeuvre.nom_oeuvre %>": "<%= oeuvre_path(oeuvre) %>",
      <% end %>
      <% @designers.each do |designer| %>
        "<%= j designer.nom_designer %>": "<%= designer_path(designer) %>",
      <% end %>
    };

    // Initialise l'autocomplétion
    autocomplete(document.getElementById("workSearch"), works.concat(designers), routeMap);
  });
</script>
<script>
  $(document).ready(function() {
    var workSearchInput = document.getElementById("workSearch");

    workSearchInput.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault(); // Empêche le comportement par défaut
        document.querySelector("form").submit(); // Soumettre le formulaire
      }
    });
  });
</script>
