<% content_for :title, "Explorer le carnet de références et de designers - Omniscient Design" %>
<% content_for :description, "Explorez Omniscient Design, le meilleur carnet de référence numérique. Un répertoire unique avec des infos sur les travaux et la vie des designers." %>
<%# <%= javascript_include_tag "controllers/loadMore", defer: true %>
<%# <%= javascript_include_tag "controllers/scrollCardsIndex", defer: true %>
<style>
  @media screen and (max-width: 320px) {
    .top-bar-search {
      display: none;
    }
    #cardContainer {
      height: calc(100vh - 50px); /* Ajuster la hauteur pour les petits écrans */
    }
  }
  #cardContainer {
    position: relative;
    height: 100dvh; /* Hauteur de l'écran */
    overflow-y: scroll; /* Active le scroll vertical uniquement */
    scroll-snap-type: y mandatory; /* Active le snap pour le défilement vertical */
    -webkit-overflow-scrolling: touch; /* Pour un défilement fluide sur mobile */
  }
  .box-card{
    display: flex;
    flex-direction: column;
  }

  body {
    margin: 0;
    overflow: hidden; /* Désactive le scroll global */
  }
</style>
<section class="home-page top-bar-search">
  <%= link_to search_oeuvres_path, class: "search-link" do %>
    <input id="workSearch" name="query" autocomplete="off" class="search-top-bar" type="search" placeholder="Rechercher une référence" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;15&quot; height=&quot;15&quot; viewBox=&quot;0 0 15 15&quot; fill=&quot;none&quot;><path d=&quot;M14.7564 13.4147L11.9565 10.6231C12.8599 9.47218 13.3501 8.051 13.3482 6.58794C13.3482 5.28497 12.9619 4.01126 12.238 2.92788C11.5141 1.8445 10.4852 1.00011 9.2814 0.50148C8.07761 0.00285444 6.753 -0.127609 5.47506 0.126588C4.19713 0.380785 3.02327 1.00823 2.10193 1.92957C1.18059 2.8509 0.553149 4.02476 0.298952 5.3027C0.0447546 6.58063 0.175218 7.90525 0.673843 9.10903C1.17247 10.3128 2.01686 11.3417 3.10024 12.0656C4.18362 12.7895 5.45733 13.1759 6.7603 13.1759C8.22336 13.1777 9.64455 12.6875 10.7954 11.7842L13.5871 14.584C13.6636 14.6612 13.7547 14.7225 13.855 14.7643C13.9554 14.8061 14.063 14.8276 14.1717 14.8276C14.2804 14.8276 14.3881 14.8061 14.4884 14.7643C14.5888 14.7225 14.6799 14.6612 14.7564 14.584C14.8336 14.5075 14.8949 14.4164 14.9367 14.3161C14.9785 14.2157 15 14.1081 15 13.9994C15 13.8907 14.9785 13.783 14.9367 13.6827C14.8949 13.5823 14.8336 13.4912 14.7564 13.4147ZM1.81935 6.58794C1.81935 5.61071 2.10913 4.65543 2.65205 3.84289C3.19497 3.03036 3.96664 2.39706 4.86948 2.02309C5.77232 1.64913 6.76578 1.55128 7.72424 1.74193C8.68269 1.93257 9.56308 2.40315 10.2541 3.09416C10.9451 3.78516 11.4157 4.66556 11.6063 5.62401C11.797 6.58246 11.6991 7.57592 11.3251 8.47876C10.9512 9.3816 10.3179 10.1533 9.50535 10.6962C8.69281 11.2391 7.73753 11.5289 6.7603 11.5289C5.44988 11.5289 4.19313 11.0083 3.26652 10.0817C2.33991 9.15511 1.81935 7.89836 1.81935 6.58794Z&quot; fill=&quot;%23202020&quot;/></svg>'); background-repeat: no-repeat; background-position-x: 20px; background-position-y: center;">
<% end %>
<div class="top-bar-flex">
  <%= link_to notifications_path do %>
    <div class="circle circle-notif">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20.1825 5.26C19.3238 4.76133 18.7932 3.83333 18.7945 2.83333V2.82933C18.7958 1.26667 17.5438 0 15.9998 0C14.4558 0 13.2038 1.26667 13.2038 2.82933V2.83333C13.2052 3.83467 12.6758 4.76133 11.8158 5.26C5.59317 8.876 9.16917 20.88 2.6665 23.0013V25.3333H29.3332V23.0013C22.8305 20.88 26.4065 8.876 20.1825 5.26ZM15.9998 1.33333C16.7358 1.33333 17.3332 1.932 17.3332 2.66667C17.3332 3.40267 16.7358 4 15.9998 4C15.2638 4 14.6665 3.40267 14.6665 2.66667C14.6665 1.932 15.2638 1.33333 15.9998 1.33333ZM19.9998 28C19.9998 30.1307 18.1438 32 16.0385 32C13.9332 32 11.9998 30.1307 11.9998 28H19.9998Z" fill="white"/>
      </svg>
      <% if current_user %>
        <% if @unread_notifications_count > 0 %>
          <div class="notification-counter">
            <div class="notification-badge"><%= @unread_notifications_count %></div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
  <%= link_to new_feedback_url do %>
    <div class="circle circle-notif">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_3261_185)">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M21 25.073C17.7533 24.321 14.0613 22.3983 15.524 19.625C19.9786 11.181 16.7053 6.66634 12.0013 6.66634C7.20263 6.66634 4.00929 11.3543 8.47596 19.625C9.98396 22.4143 6.17729 24.337 2.99996 25.073C0.0999594 25.745 -0.00937402 27.1903 -4.06868e-05 29.7183L0.00529265 30.6663H23.996L24 29.7477C24.0093 27.2023 23.912 25.7477 21 25.073ZM18.9386 14.6663C19.468 13.5077 20.056 11.9157 20.0253 10.8063C19.312 9.85967 18.9093 8.63967 18.9093 7.39834C18.9093 3.89434 21.9973 1.33301 25.4546 1.33301C28.8906 1.33301 32 3.87567 32 7.39834C32 11.0663 28.328 14.4917 23.2906 13.129C22.376 13.753 20.3573 14.381 18.9386 14.6663ZM24.5186 6.17167L22.396 6.46501L23.9413 7.95034L23.564 10.0597L25.4546 9.04901L27.344 10.0597L26.968 7.95034L28.5133 6.46501L26.3893 6.17167L25.4546 4.24234L24.5186 6.17167Z" fill="white"/>
        </g>
      </svg>
    </div>
  <% end %>
</div>
</section>
<div id="oeuvres">
  <div class="home-flex" id="cardContainer">
    <div class="nav-home-mobile">
      <%= image_tag("logo.svg", alt: "Logo", class: "logo-img") %>
      <div>
        <%= link_to "Designers", designers_path %> |
        <%= link_to "Références", oeuvres_path, class: "active" %>
      </div>
      <%= link_to search_oeuvres_path do %>
        <svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.8193 9.9518L8.74218 7.8808C9.41235 7.02701 9.77598 5.9727 9.77463 4.88732C9.77463 3.9207 9.48799 2.97578 8.95097 2.17207C8.41394 1.36836 7.65065 0.741936 6.75761 0.372027C5.86457 0.00211759 4.88189 -0.0946675 3.93385 0.0939106C2.9858 0.282489 2.11497 0.74796 1.43146 1.43146C0.74796 2.11497 0.282489 2.9858 0.0939106 3.93385C-0.0946675 4.88189 0.00211759 5.86457 0.372027 6.75761C0.741936 7.65065 1.36836 8.41394 2.17207 8.95097C2.97578 9.48799 3.9207 9.77463 4.88732 9.77463C5.9727 9.77598 7.02701 9.41235 7.8808 8.74218L9.9518 10.8193C10.0086 10.8766 10.0762 10.922 10.1506 10.953C10.225 10.984 10.3049 11 10.3855 11C10.4662 11 10.546 10.984 10.6205 10.953C10.6949 10.922 10.7625 10.8766 10.8193 10.8193C10.8766 10.7625 10.922 10.6949 10.953 10.6205C10.984 10.546 11 10.4662 11 10.3855C11 10.3049 10.984 10.225 10.953 10.1506C10.922 10.0762 10.8766 10.0086 10.8193 9.9518ZM1.22183 4.88732C1.22183 4.16235 1.43681 3.45367 1.83958 2.85088C2.24234 2.2481 2.81482 1.77828 3.4846 1.50085C4.15438 1.22342 4.89138 1.15083 5.60242 1.29226C6.31345 1.4337 6.96658 1.7828 7.47921 2.29543C7.99183 2.80805 8.34094 3.46118 8.48237 4.17222C8.6238 4.88325 8.55122 5.62026 8.27378 6.29004C7.99635 6.95982 7.52654 7.53229 6.92375 7.93506C6.32096 8.33782 5.61228 8.5528 4.88732 8.5528C3.91517 8.5528 2.98284 8.16662 2.29543 7.47921C1.60801 6.79179 1.22183 5.85946 1.22183 4.88732Z" fill="#202020"/>
        </svg>
      <%end%>
    </div>
    <p class="nav-home">
      <%= link_to "Designers", designers_path %> |
      <%= link_to "Références", oeuvres_path, class: "active" %>
    </p>
    <div class="box-card" id="boxCard">
      <%= render partial: 'oeuvres/card', collection: @oeuvres, as: :card, locals: { class_name: 'card' } %>
    </div>
    <div id="load-more-trigger" data-offset="2" data-loaded-ids="<%= @oeuvres.pluck(:id).join(',') %>"></div>
  </div>
  <div class="button-nav">
    <button class="arrow-button up">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 38L18 40L22 40L22 38L18 38ZM22 6C22 4.89543 21.1046 4 20 4C18.8954 4 18 4.89543 18 6L22 6ZM22 38L22 6L18 6L18 38L22 38Z" fill="white"/>
        <path d="M5 15.8408L20.0002 2.54515L35.0005 15.8408" stroke="white" stroke-width="3.65112" stroke-linecap="square"/>
      </svg>
    </button>
    <button class="arrow-button down">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 2L18 1.86484e-08L22 -1.86484e-08L22 2L18 2ZM22 34C22 35.1046 21.1046 36 20 36C18.8954 36 18 35.1046 18 34L22 34ZM22 2L22 34L18 34L18 2L22 2Z" fill="white"/>
        <path d="M5 24.1592L20.0002 37.4549L35.0005 24.1592" stroke="white" stroke-width="3.65112" stroke-linecap="square"/>
      </svg>
    </button>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("cardContainer");
    const loadMoreTrigger = document.getElementById("load-more-trigger");
    const upButton = document.querySelector(".arrow-button.up");
    const downButton = document.querySelector(".arrow-button.down");
    let isLoading = false;
    let isScrolling = false;

    // Fonction de chargement des cartes
    function loadMoreCards() {
      if (isLoading) return;
      isLoading = true;

      const offset = loadMoreTrigger.dataset.offset;
      const loadedIds = loadMoreTrigger.dataset.loadedIds.split(',');

      fetch(`/oeuvres/load_more?offset=${offset}&loaded_ids=${loadedIds.join(',')}`)
        .then((response) => response.text())
        .then((html) => {
          if (html.trim() === "") {
            loadMoreTrigger.style.display = "none"; // Cache le bouton si aucun contenu
          } else {
            container.insertAdjacentHTML("beforeend", html);

            // Mettre à jour l'offset et les IDs chargés
            loadMoreTrigger.dataset.offset = parseInt(offset) + 2;
            const newLoadedIds = Array.from(container.querySelectorAll('.card')).map(card => card.dataset.id);
            loadMoreTrigger.dataset.loadedIds = [...new Set([...loadedIds, ...newLoadedIds])].join(',');

            // Assurez-vous que les cartes s'alignent bien
            validateCardAlignment();
          }
          isLoading = false;
        })
        .catch((err) => {
          console.error("Erreur lors du chargement des cartes :", err);
          isLoading = false;
        });
    }

    // Vérification et ajustement de l'alignement des cartes
    function validateCardAlignment() {
      const cards = container.querySelectorAll(".card");
      cards.forEach((card) => {
        card.style.marginBottom = "10px"; // Assure un espacement cohérent entre les cartes
      });
    }

    // Fonction pour défiler vers le haut ou le bas
    function scrollByAmount(amount) {
      container.scrollBy({ top: amount, behavior: "smooth" });
    }

    // Gestion des boutons
    upButton.addEventListener("click", () => scrollByAmount(-window.innerHeight / 2));
    downButton.addEventListener("click", () => scrollByAmount(window.innerHeight / 2));

    // Gestion tactile (mobile-friendly)
    let touchStartY = 0;
    let touchEndY = 0;

    container.addEventListener("touchstart", (e) => {
      touchStartY = e.touches[0].clientY;
    });

    container.addEventListener("touchend", (e) => {
      if (isScrolling) return; // Ne pas gérer les événements tactiles pendant le défilement

      touchEndY = e.changedTouches[0].clientY;
      const swipeDistance = touchStartY - touchEndY;

      if (swipeDistance > 50) {
        // Swipe up
        scrollByAmount(window.innerHeight / 2);
      } else if (swipeDistance < -50) {
        // Swipe down
        scrollByAmount(-window.innerHeight / 2);
      }
    });

    // Gestion des touches du clavier
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp") {
        // Flèche Haut
        scrollByAmount(-window.innerHeight / 2);
      } else if (e.key === "ArrowDown") {
        // Flèche Bas
        scrollByAmount(window.innerHeight / 2);
      }
    });

    // Ajustement initial
    validateCardAlignment();

    // Écouteur de défilement pour le chargement infini
    container.addEventListener("scroll", () => {
      const { scrollTop, scrollHeight, clientHeight } = container;
      isScrolling = true;

      if (scrollTop + clientHeight >= scrollHeight - 100) {
        loadMoreCards();
      }

      setTimeout(() => (isScrolling = false), 100);
    });
  });
</script>
