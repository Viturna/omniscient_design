<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartkick@5.0.1/dist/chartkick.js"></script>
<style>
  /* --- CSS GLOBAL --- */
  .users-dash-wrapper {
    padding: 40px 4vw 80px 4vw;
    max-width: 1600px;
    margin: 0 auto;
    background-color: #f8f9fa;
    min-height: 100vh;
    font-family: 'IBM Plex Sans', sans-serif;
    color: #202020;
  }

  .users-dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
  .users-dash-title { font-size: 32px; font-weight: 500; color: #202020; display: flex; align-items: center; gap: 16px; margin: 0; }
  .users-dash-back-link {
    display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: 50%;
    background-color: #fff; border: 1px solid #eee; transition: all 0.2s ease;
  }
  .users-dash-back-link:hover { background-color: #f0f0f0; transform: translateX(-2px); }

  /* KPIs */
  .users-dash-kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
  .users-dash-kpi-card {
    background: #fff; padding: 24px; border-radius: 16px; border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: space-between; height: 160px;
  }
  .kpi-top { display: flex; justify-content: space-between; align-items: flex-start; }
  .kpi-label { font-size: 14px; font-weight: 500; color: #888; text-transform: uppercase; }
  .kpi-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
  .kpi-icon svg { width: 20px; height: 20px; fill: #202020; }
  .kpi-value { font-size: 32px; font-weight: 600; color: #202020; margin-top: 10px; line-height: 1; }
  .kpi-subtext { font-size: 13px; color: #666; margin-top: 8px; display: flex; gap: 10px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
  .dot-oeuvre { background: #333; }
  .dot-designer { background: #888; }

  .bg-blue-light { background-color: #E3F2FD; color: #1565C0; }
  .bg-green-light { background-color: #E8F5E9; color: #2E7D32; }
  .bg-orange-light { background-color: #FFF3E0; color: #EF6C00; }
  .bg-red-light { background-color: #FFEBEE; color: #C62828; }

  /* Charts */
  .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 40px; }
  .chart-card { background: #fff; border-radius: 16px; padding: 24px; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }

  /* Header du Graphique avec Filtres */
  .chart-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .chart-title { font-size: 16px; font-weight: 600; color: #202020; margin: 0; }
  .chart-filters { display: flex; gap: 8px; }
  .chart-btn {
    background: none; border: 1px solid #ddd; padding: 4px 12px; border-radius: 20px;
    cursor: pointer; font-size: 12px; color: #666; font-weight: 500; transition: all 0.2s;
  }
  .chart-btn:hover { background: #f0f0f0; }
  .chart-btn.active { background: #202020; color: #fff; border-color: #202020; }

  /* Table & Scroll Fix */
  .section-title { font-size: 18px; font-weight: 600; color: #202020; margin-bottom: 20px; display: block; }

  .users-dash-table-container {
    background: #fff; border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #f0f0f0;
    /* IMPORTANT POUR LE SCROLL POPUP : visible au lieu de hidden/auto */
    overflow: visible;
    margin-bottom: 48px;
    position: relative;
    z-index: 1;
  }
  .users-dash-table { width: 100%; border-collapse: separate; border-spacing: 0; }
  .users-dash-table th {
    background-color: #fafafa; padding: 18px 24px; text-align: left;
    font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase;
    border-bottom: 1px solid #eee;
  }
  .users-dash-table td {
    padding: 18px 24px; border-bottom: 1px solid #f5f5f5;
    font-size: 14px; font-weight: 500; color: #202020; vertical-align: middle;
  }
  .users-dash-table tr:hover { background-color: #fcfcfc; }

  /* User Info */
  .user-cell { display: flex; align-items: center; gap: 12px; }
  .user-avatar {
    width: 36px; height: 36px; border-radius: 50%; background: #eee;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; color: #666; overflow: hidden;
  }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-info { display: flex; flex-direction: column; }
  .user-name { font-weight: 600; color: #202020; }
  .user-email { font-size: 12px; color: #888; }
  .stat-number { font-weight: 600; }
  .stat-valid { color: #2E7D32; background: #E8F5E9; padding: 4px 8px; border-radius: 4px; }
  .stat-pending { color: #EF6C00; background: #FFF3E0; padding: 4px 8px; border-radius: 4px; }
  .stat-refused { color: #C62828; background: #FFEBEE; padding: 4px 8px; border-radius: 4px; }

  /* --- ACCORDÉON & SCROLL FIX --- */
  details.ref-dropdown { position: relative; width: 100%; }
  details.ref-dropdown summary {
    list-style: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
    background: #f5f5f5; padding: 6px 12px; border-radius: 6px;
    font-size: 12px; font-weight: 600; color: #444; transition: all 0.2s; white-space: nowrap;
  }
  details.ref-dropdown summary:hover { background: #eee; color: #000; }
  details.ref-dropdown summary::-webkit-details-marker { display: none; }
  details.ref-dropdown summary::after {
    content: url('data:image/svg+xml;utf8,<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><polyline points="6 9 12 15 18 9"></polyline></svg>');
    display: block; width: 10px; height: 10px; transition: transform 0.2s;
  }
  details.ref-dropdown[open] summary::after { transform: rotate(180deg); }

  .refs-popover {
    position: absolute; right: 0; top: 100%;
    /* Z-INDEX TRÈS ÉLEVÉ pour passer au dessus des lignes suivantes */
    z-index: 9999;
    margin-top: 4px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
    padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 300px;
    /* SCROLL INTERNE */
    max-height: 250px; overflow-y: auto;
    overscroll-behavior: contain; /* Empêche de scroller la page quand on est au bout du popup */
  }

  .ref-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px; border-radius: 6px; text-decoration: none;
    border-bottom: 1px solid #f9f9f9; cursor: pointer;
  }
  .ref-item:last-child { border-bottom: none; }
  .ref-item:hover { background-color: #f3f4f6; }
  .ref-icon {
    width: 24px; height: 24px; border-radius: 4px; background: #eee; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
  }
  .ref-content { flex: 1; min-width: 0; }
  .ref-title { font-size: 13px; font-weight: 500; color: #333; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ref-meta { font-size: 11px; color: #999; display: flex; justify-content: space-between; margin-top: 2px; }
  .badge-mini { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
  .status-true { background: #E8F5E9; color: #2E7D32; }
  .status-false { background: #FFF3E0; color: #EF6C00; }
  .status-nil { background: #FFF3E0; color: #EF6C00; }

  /* Custom Scrollbar */
  .refs-popover::-webkit-scrollbar { width: 6px; }
  .refs-popover::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
  .refs-popover::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
  .refs-popover::-webkit-scrollbar-thumb:hover { background: #bbb; }
</style>
<div class="users-dash-wrapper">
  <div class="users-dash-header">
    <div style="display: flex; align-items: center; gap: 20px;">
      <%= link_to admin_root_path, class: "users-dash-back-link" do %>
        <svg style="width: 24px; height: 24px; fill: #202020;" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      <% end %>
      <h1 class="users-dash-title">Rapport des Références</h1>
    </div>
  </div>
  <div class="users-dash-kpi-grid">
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Total Références</span>
        <div class="kpi-icon bg-blue-light">
          <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H6V4h5v8l2.5-1.5L16 12V4h2v16z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @total_refs %></span>
      <div class="kpi-subtext">
        <span><span class="dot dot-oeuvre"></span><%= @count_oeuvres %> Oeuvres</span>
        <span><span class="dot dot-designer"></span><%= @count_designers %> Designers</span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Validées</span>
        <div class="kpi-icon bg-green-light">
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @refs_validees %></span>
      <div class="kpi-subtext">
        <span><span class="dot dot-oeuvre"></span><%= @val_oeuvres %></span>
        <span><span class="dot dot-designer"></span><%= @val_designers %></span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">En attente</span>
        <div class="kpi-icon bg-orange-light">
          <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @refs_en_attente %></span>
      <div class="kpi-subtext">
        <span><span class="dot dot-oeuvre"></span><%= @pending_oeuvres %></span>
        <span><span class="dot dot-designer"></span><%= @pending_designers %></span>
      </div>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Refusées</span>
        <div class="kpi-icon bg-red-light">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @refs_refusees %></span>
      <div class="kpi-subtext">
        <span><span class="dot dot-oeuvre"></span><%= @refused_oeuvres %></span>
        <span><span class="dot dot-designer"></span><%= @refused_designers %></span>
      </div>
    </div>
  </div>
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-header-row">
        <span class="chart-title">Évolution soumissions</span>
        <div class="chart-filters">
          <button class="chart-btn" onclick="updatePeriod('7d')" data-period="7d">7J</button>
          <button class="chart-btn" onclick="updatePeriod('30d')" data-period="30d">30J</button>
          <button class="chart-btn" onclick="updatePeriod('6m')" data-period="6m">6M</button>
          <button class="chart-btn" onclick="updatePeriod('12m')" data-period="12m">12M</button>
        </div>
      </div>
      <%= line_chart @evolution_detail, height: "250px", colors: ["#333", "#888"], library: { scales: { x: { grid: { display: false } }, y: { display: true } } } %>
    </div>
    <div class="chart-card">
      <span class="chart-title">État global</span>
      <%= pie_chart @repartition_status, donut: true, height: "250px", colors: ["#2E7D32", "#EF6C00", "#C62828"], legend: "right" %>
    </div>
  </div>
  <span class="section-title">Détail par utilisateur</span>
  <div class="users-dash-table-container">
    <table class="users-dash-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th style="text-align:center;">Total Émises</th>
          <th style="text-align:center;">Validées</th>
          <th style="text-align:center;">En attente</th>
          <th style="text-align:center;">Détails</th>
        </tr>
      </thead>
      <tbody>
        <% if @suivis.present? %>
          <% @suivis.each do |suivi| %>
            <tr>
              <td>
                <div class="user-cell">
                  <div class="user-avatar">
                    <% if suivi.user.profile_image.present? %>
                      <%= image_tag suivi.user.profile_image %>
                    <% else %>
                      <%= suivi.user.firstname&.first&.upcase %>
                    <% end %>
                  </div>
                  <div class="user-info">
                    <span class="user-name"><%= suivi.user.firstname %> <%= suivi.user.lastname %></span>
                    <span class="user-email"><%= suivi.user.email %></span>
                  </div>
                </div>
              </td>
              <td style="text-align:center;"><span class="stat-number"><%= suivi.nb_references_emises %></span></td>
              <td style="text-align:center;"><span class="stat-number stat-valid"><%= suivi.nb_references_validees %></span></td>
              <td style="text-align:center;"><span class="stat-number stat-pending"><%= suivi.nb_references_non_validees %></span></td>
              <td style="text-align:center;">
                <details class="ref-dropdown">
                  <summary>Voir les items</summary>
                  <div class="refs-popover">
                    <% 
                      last_oeuvres = suivi.user.oeuvres.order(created_at: :desc).limit(10)
                      last_designers = suivi.user.designers.order(created_at: :desc).limit(10)
                      all_items = (last_oeuvres + last_designers).sort_by(&:created_at).reverse.first(10)
                    %>
                    <% if all_items.any? %>
                      <% all_items.each do |item| %>
                        <% is_oeuvre = item.is_a?(Oeuvre) %>
                        <%= link_to (is_oeuvre ? oeuvre_path(item) : designer_path(item)), class: "ref-item", target: "_blank" do %>
                          <div class="ref-icon"><%= is_oeuvre ? "O" : "D" %></div>
                          <div class="ref-content" style="text-align: left;">
                            <span class="ref-title"><%= item.respond_to?(:name) ? item.name : (item.respond_to?(:title) ? item.title : "Sans titre") %></span>
                            <div class="ref-meta">
                              <span><%= is_oeuvre ? "Oeuvre" : "Designer" %></span>
                              <span class="badge-mini status-<%= item.validation %>">
                                <%= item.validation ? "Validé" : "Attente" %>
                              </span>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    <% else %>
                      <div style="padding:10px; color:#999; font-size:12px; text-align:center;">Aucune référence récente</div>
                    <% end %>
                  </div>
                </details>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
    <% if @suivis.respond_to?(:total_pages) %>
      <div style="padding: 24px; display: flex; justify-content: center; border-top: 1px solid #eee;">
        <%= paginate @suivis %>
      </div>
    <% end %>
  </div>
</div>
<script>
  // Script filtre graphique
  function updatePeriod(period) {
    const url = new URL(window.location);
    url.searchParams.set('ref_period', period);
    window.location = url;
  }

  // Active le bouton actuel
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const period = params.get('ref_period') || '6m';
    document.querySelectorAll('.chart-btn').forEach(btn => {
      if(btn.dataset.period === period) btn.classList.add('active');
    });
  });

  // Gestion des dropdowns et du scroll
  document.addEventListener("click", function(e) {
    // Si on clique sur un summary, fermer les autres
    if (e.target.tagName === "SUMMARY") {
      document.querySelectorAll("details.ref-dropdown[open]").forEach(detail => {
        if (detail !== e.target.parentElement) {
          detail.removeAttribute("open");
        }
      });
    }
  });

  // Empêcher la fermeture si on clique DANS la popover (important pour le scrollbar)
  document.querySelectorAll('.refs-popover').forEach(popover => {
    popover.addEventListener('click', function(e) {
      e.stopPropagation(); // Empêche le clic de remonter et de fermer le details
    });
  });
</script>