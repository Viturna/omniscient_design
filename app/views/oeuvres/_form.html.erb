<div data-controller="multi-step-form" 
     data-multi-step-form-edit-mode-value="<%= @oeuvre.persisted? %>">

  <%= form_with(model: @oeuvre, id: "oeuvre-form", local: true, data: { controller: "recaptcha", recaptcha_target: "form" }) do |form| %>
    
    <%= hidden_field_tag :recaptcha_token, nil, id: "recaptcha_token", data: { recaptcha_target: "token" } %>
    
   <div class="error-message" style="color: red; display: none;" data-multi-step-form-target="errorMessage"></div>
    
    <% if @oeuvre.errors.any? %>
      <div style="color: red; margin-bottom: 20px;">
        <ul>
          <% @oeuvre.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-step" data-multi-step-form-target="step" style="<%= @oeuvre.persisted? ? 'display: none;' : 'display: block;' %>">
      <h3>Critères d’acceptation des références et designers</h3>
      <p>
        Afin de garantir la qualité, la cohérence et le respect du travail de chacun, toute soumission sur omniscientdesign.fr doit respecter les critères suivants.
        <br><br>
        <span style="font-weight:500;">⚠️ Le non-respect de ces règles entraînera la suppression immédiate du contenu et le bannissement définitif du compte. Aucune seconde chance ne sera accordée.</span>
      </p>
      <hr class="rules-add-hr">
      
      <h4>1. Originalité et Authenticité</h4>
      <ul>
        <li>Chaque référence doit être <strong>originale</strong>, conçue par son auteur.</li>
        <li>Chaque référence doit être clairement sourcée.</li>
      </ul>
      <h4>2. Qualité visuelle</h4>
      <ul>
        <li>Images <strong>nettes</strong> et en <strong>haute résolution</strong>.</li>
        <li>Formats acceptés : PNG, JPG, WEBP.</li>
        <li>Aucune image <strong>floue</strong> ou <strong>pixelisée</strong> ne sera acceptée.</li>
      </ul>
      <h4>3. Respect des droits d’auteur</h4>
      <ul>
        <li>Vous devez avoir les <strong>droits d’utilisation complets</strong> sur tous les éléments partagés.</li>
        <li>Pas d’infraction aux droits d’auteur.</li>
      </ul>
      <h4>4. Description détaillée</h4>
      <ul>
        <li>Fournir des descriptions complètes (artiste, technique, contexte...).</li>
        <li>Le texte doit être rédigé correctement, <strong>sans fautes d’orthographe</strong> majeures ni langage familier.</li>
        <li>Les descriptions doivent être <strong>factuelles</strong> et <strong>neutres</strong>, sans jugement ni prise de parti.</li>
      </ul>
      <h4>5. Pertinence et cohérence</h4>
      <ul>
        <li>Doit être pertinente pour la communauté et ne pas dupliquer du contenu existant.</li>
      </ul>
      <h4>6. Contenu responsable</h4>
      <ul>
        <li>Pas de contenu discriminatoire, violent, politique, religieux ou trollesque.</li>
      </ul>
      
      <p>Soumettre une référence sur omniscientdesign.fr signifie que vous acceptez pleinement ces conditions et vous engagez à les respecter.</p>
      
      <div style="margin-top:48px;">
        <label style="font-weight: 500; cursor: pointer;">
          <input type="checkbox" 
                 id="accept-rules-checkbox" 
                 data-multi-step-form-target="rulesCheckbox"
                 data-action="change->multi-step-form#toggleRules">
          J’ai lu et j’accepte le règlement ci-dessus
        </label>
      </div>

      <div class="flex-btn-add" style="justify-content:flex-end; margin-top:1rem;">
        <button type="button" 
                class="button large" 
                disabled 
                data-multi-step-form-target="rulesNextBtn"
                data-action="click->multi-step-form#next">
          <%= t('add_oeuvre.buttons.next') %>
        </button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="<%= @oeuvre.persisted? ? 'display: block;' : 'display: none;' %>">
      <h3><%= t('add_oeuvre.steps.1.title') %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :nom_oeuvre, t('add_oeuvre.steps.1.nom_oeuvre') %>
          <%= form.text_field :nom_oeuvre, 
              required: true, 
              placeholder: t('add_oeuvre.steps.1.nom_oeuvre_placeholder'),
              data: { multi_step_form_target: "nameInput" } 
          %>
        </div>
      </div>
      <div class="flex-btn-add" style="justify-content: flex-end;">
        <button type="button" class="prev-step button large" style="margin-right: 10px;" data-action="click->multi-step-form#prev" data-multi-step-form-target="prevButton">
          <%= t('add_oeuvre.buttons.prev') %>
        </button>
        <button type="button" class="button large" data-action="click->multi-step-form#next">
          <%= t('add_oeuvre.buttons.next') %>
        </button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="display: none;">
      <h3><%= t('add_oeuvre.steps.2.title') %></h3>
      <div class="flex-form">
        <div data-controller="multi-select" data-multi-select-prefix-value="designer">
          <%= form.label :designer_ids, t('add_oeuvre.steps.2.designer_ids') %>
          <% max_designers = 3 %>
          <% selected_designers = @oeuvre.designer_ids %>
          <% (0...max_designers).each do |index| %>
            <div>
              <%= form.collection_select :designer_ids,
                Designer.order(:nom),
                :id,
                :nom_designer,
                { 
                  include_blank: t('add_oeuvre.steps.2.designer_blank'),
                  prompt: t('add_oeuvre.steps.2.designer_prompt'),
                  selected: selected_designers[index]
                },
                { 
                  class: "form-control designer-select",
                  id: "designer_#{index + 1}",
                  name: "oeuvre[designer_ids][]"
                } %>
            </div>
          <% end %>
          <div>
            <%= form.label :studio_ids, 'Studio(s) associé(s)' %>
            <%= form.collection_select :studio_ids, 
                Studio.order(:nom), 
                :id, 
                :nom, 
                { include_blank: true, selected: @oeuvre.studio_ids }, 
                { 
                  class: "form-control studio-select", 
                  multiple: true, 
                  name: "oeuvre[studio_ids][]",
                  data: { placeholder: "Sélectionnez un ou plusieurs studios..." }
                } %>
          </div>
        </div>
        
        <%= form.label :notion_ids, t('add_oeuvre.steps.2.notion_ids') %>
        <%= form.collection_select :notion_ids, Notion.order(:name), :id, :name, { include_blank: false }, { class: "form-control notions-select", multiple: true, name: "oeuvre[notion_ids][]" } %>
        
        <div>
          <%= form.label :domaine_ids, t('add_oeuvre.steps.2.domaine_id') %>
          <%= form.collection_select :domaine_ids, 
              Domaine.order(:domaine), 
              :id, 
              :domaine, 
              { include_blank: false, selected: @oeuvre.domaine_ids }, 
              { class: "form-control domaine-select", multiple: true, name: "oeuvre[domaine_ids][]" } %>
        </div>
         <div>
          <%= form.label :date_oeuvre, t('add_oeuvre.steps.4.date_oeuvre') %>
          <%= form.text_field :date_oeuvre, required: true, placeholder: t('add_oeuvre.steps.4.date_oeuvre_placeholder'), id: "date-oeuvre-input" %>
          <div id="date-oeuvre-error" style="color: red; font-size: 0.9em;"></div>
        </div>
        
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_oeuvre.buttons.prev') %></button>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_oeuvre.buttons.next') %></button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="display: none;">
      <h3><%= t('add_oeuvre.steps.3.title') %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :presentation_generale, t('add_oeuvre.steps.3.presentation_generale') %>
          <%= form.text_area :presentation_generale, placeholder: t('add_oeuvre.steps.3.presentation_generale_placeholder') %>
        </div>
        <div>
          <%= form.label :contexte_historique, t('add_oeuvre.steps.3.contexte_historique') %>
          <%= form.text_area :contexte_historique, placeholder: t('add_oeuvre.steps.3.contexte_historique_placeholder') %>
        </div>
        <div>
          <%= form.label :materiaux_et_innovations_techniques, t('add_oeuvre.steps.3.materiaux_et_innovations_techniques') %>
          <%= form.text_area :materiaux_et_innovations_techniques, placeholder: t('add_oeuvre.steps.3.materiaux_et_innovations_techniques_placeholder') %>
        </div>
        <div>
          <%= form.label :concept_et_inspiration, t('add_oeuvre.steps.3.concept_et_inspiration') %>
          <%= form.text_area :concept_et_inspiration, placeholder: t('add_oeuvre.steps.3.concept_et_inspiration_placeholder') %>
        </div>
        <div>
          <%= form.label :dimension_esthetique, t('add_oeuvre.steps.3.dimension_esthetique') %>
          <%= form.text_area :dimension_esthetique, placeholder: t('add_oeuvre.steps.3.dimension_esthetique_placeholder') %>
        </div>
        <div>
          <%= form.label :impact_et_message, t('add_oeuvre.steps.3.impact_et_message') %>
          <%= form.text_area :impact_et_message, placeholder: t('add_oeuvre.steps.3.impact_et_message_placeholder') %>
        </div>
      
        <div data-controller="sources" data-sources-prefix-value="oeuvre">
          <%= form.label :source, t('add_oeuvre.steps.3.source') %>
          <div id="sources-container" data-sources-target="container">
            <% (@oeuvre.source || []).each do |src| %>
              <div class="source-input">
                <%= text_field_tag "oeuvre[source][]", src, placeholder: t('add_oeuvre.steps.3.source_placeholder') %>
                <button type="button" class="remove-source button small">×</button>
              </div>
            <% end %>
            <% if (@oeuvre.source || []).empty? %>
               <div class="source-input">
                <%= text_field_tag "oeuvre[source][]", "", placeholder: t('add_oeuvre.steps.3.source_placeholder') %>
                <button type="button" class="remove-source button small">×</button>
              </div>
            <% end %>
          </div>
          <button type="button" id="add-source" data-sources-target="addButton" class="button small"><%= t('add_oeuvre.steps.3.add_source_button') %></button>
        </div>
      </div>
      
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_oeuvre.buttons.prev') %></button>
        <button type="button" class="button large" data-action="click->multi-step-form#next"><%= t('add_oeuvre.buttons.next') %></button>
      </div>
    </div>

    <div class="form-step" data-multi-step-form-target="step" style="display: none;">
      <h3><%= t('add_oeuvre.steps.4.title') %></h3>
      <div class="flex-form">
        <div>
          <%= form.label :images, "#{t('add_oeuvre.steps.4.image')} (3 max - Glissez pour réorganiser)" %>
          <div id="image-fields-container" 
               class="image-grid-container"
               data-controller="sortable">
            <%= form.fields_for :oeuvre_images, @oeuvre.oeuvre_images.sort_by { |img| img.position || 0 } do |image_form| %>
              <div class="image-upload-card" 
                   data-controller="image-preview" 
                   data-sortable-target="item">
                <%= image_form.hidden_field :position, data: { 'sortable-target': 'positionInput' } %>
                <div class="image-drag-handle">
                  ⬍ Glisser (Position <%= image_form.object.position || 'N/A' %>)
                </div>
                <% if image_form.object.persisted? && image_form.object.file.attached? %>
                  <div class="image-preview-existing">
                    <%= image_tag image_form.object.file, class: "image-preview-img" %>
                    <div class="image-delete-overlay">
                      <%= image_form.label :_destroy, "×", class: "delete-image-btn", title: "Supprimer" %>
                      <%= image_form.check_box :_destroy %>
                    </div>
                  </div>
                  <div>
                    <div data-image-preview-target="container"></div>
                    <%= image_form.file_field :file, 
                      accept: "image/png,image/jpeg,image/jpg,image/webp",
                      data: { 
                        action: "change->image-preview#preview",
                        image_preview_target: "input" 
                      } %>
                    <%= image_form.text_field :credit, placeholder: "Crédit photo", class: "image-credit-field" %>
                  </div>
                <% else %>
                  <div class="image-preview-new" data-image-preview-target="container"></div>
                  <div style="flex-grow: 1;">
                    <%= image_form.file_field :file, 
                      accept: "image/png,image/jpeg,image/jpg,image/webp",
                      data: { 
                        action: "change->image-preview#preview",
                        image_preview_target: "input" 
                      } %>
                    <%= image_form.text_field :credit, placeholder: "Crédit photo", class: "image-credit-field" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <div class="flex-btn-add">
        <button type="button" class="button large" data-action="click->multi-step-form#prev"><%= t('add_oeuvre.buttons.prev') %></button>
        <%= form.submit t('add_oeuvre.buttons.submit'), class: "button large" %>
      </div>
    </div>

  <% end %>
</div>

<script>
  document.addEventListener("turbo:load", () => {
     var oeuvreYearInput = document.getElementById("date-oeuvre-input");
     var oeuvreYearError = document.getElementById("date-oeuvre-error");
     
     if (oeuvreYearInput && oeuvreYearError) {
        var currentYear = new Date().getFullYear();

        function validateYear(year) {
          return !isNaN(year) && year >= 0 && year <= currentYear;
        }

        oeuvreYearInput.addEventListener("input", function() {
          if (!validateYear(this.value)) {
            oeuvreYearError.textContent = "Année invalide (entre 0 et " + currentYear + ")";
          } else {
            oeuvreYearError.textContent = "";
          }
        });
     }

     if (typeof $ !== 'undefined' && $.fn.select2) {
        function initSelect2(selector, placeholder) {
          const elements = document.querySelectorAll(selector);
          elements.forEach(el => {
            if ($(el).hasClass("select2-hidden-accessible")) {
              $(el).select2('destroy'); 
            }
            $(el).select2({
              placeholder: placeholder,
              allowClear: true,
              width: '100%',
              language: {
                noResults: function() { return "Aucun résultat trouvé"; }
              }
            });
          });
        }
        initSelect2('.designer-select', 'Sélectionnez un ou une designer...');
        initSelect2('.studio-select', 'Sélectionnez un ou plusieurs studios...');
        initSelect2('.notions-select', 'Sélectionnez une ou plusieurs notions...');
        initSelect2('.domaine-select', 'Sélectionnez un ou plusieurs domaines...');
     }
   });
</script>

<% content_for :recaptcha_script do %>
  <script src="https://www.google.com/recaptcha/api.js?render=<%= ENV["RECAPTCHA_SITE_KEY"] %>"></script>
<% end %>