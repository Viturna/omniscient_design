<style>
  /* --- REPRISE DU CSS GLOBAL DASHBOARD --- */
  .users-dash-wrapper {
    padding: 40px 4vw 80px 4vw;
    max-width: 1600px;
    margin: 0 auto;
    background-color: #f8f9fa;
    min-height: 100vh;
    font-family: 'IBM Plex Sans', sans-serif;
    color: #202020;
    box-sizing: border-box; /* Important pour responsive */
  }

  /* Header */
  .users-dash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    flex-wrap: wrap; /* Permet le passage à la ligne sur mobile */
    gap: 16px;
  }
  .users-dash-title {
    font-size: 32px; font-weight: 500; color: #202020;
    display: flex; align-items: center; gap: 16px; margin: 0;
  }
  .users-dash-back-link {
    display: flex; align-items: center; justify-content: center;
    width: 48px; height: 48px; border-radius: 50%;
    background-color: #fff; border: 1px solid #eee;
    transition: all 0.2s ease;
    flex-shrink: 0; /* Empêche l'écrasement */
  }
  .users-dash-back-link:hover { background-color: #f0f0f0; transform: translateX(-2px); }

  /* KPIs */
  .users-dash-kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
    margin-bottom: 40px;
  }
  .users-dash-kpi-card {
    background: #fff; padding: 24px; border-radius: 16px;
    border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    display: flex; flex-direction: column; height: 140px;
    min-width: 0; /* Important pour grid */
  }
  .kpi-top { display: flex; justify-content: space-between; align-items: flex-start; }
  .kpi-label { font-size: 14px; font-weight: 500; color: #888; text-transform: uppercase; }
  .kpi-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .kpi-icon svg { width: 20px; height: 20px; fill: #202020; }
  .kpi-value { font-size: 36px; font-weight: 500; color: #202020; margin-top: auto; }

  .bg-indigo-light { background-color: #E8EAF6; color: #3F51B5; }
  .bg-teal-light { background-color: #E0F2F1; color: #009688; }
  .bg-pink-light { background-color: #FCE4EC; color: #E91E63; }
  .bg-amber-light { background-color: #FFF8E1; color: #FFC107; }

  /* Tables */
  .section-title { font-size: 18px; font-weight: 600; color: #202020; margin-bottom: 20px; display: block; }

  .users-dash-table-container {
    background: #fff; border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #f0f0f0;
    overflow: hidden; margin-bottom: 48px;
    /* RESPONSIVE TABLE */
    overflow-x: auto;
  }
  .users-dash-table { width: 100%; border-collapse: collapse; min-width: 600px; /* Force le scroll sur mobile */ }
  .users-dash-table th {
    background-color: #fafafa; padding: 18px 24px; text-align: left;
    font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
  }
  .users-dash-table td {
    padding: 18px 24px; border-bottom: 1px solid #f5f5f5;
    font-size: 14px; font-weight: 500; color: #202020; vertical-align: middle;
    white-space: nowrap;
  }
  .users-dash-table tr:hover { background-color: #fcfcfc; }

  /* Avatar */
  .user-cell { display: flex; align-items: center; gap: 12px; }
  .user-avatar {
    width: 36px; height: 36px; border-radius: 50%; background: #eee;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; color: #666; overflow: hidden;
    flex-shrink: 0;
  }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-info { display: flex; flex-direction: column; }
  .user-name { font-weight: 600; color: #202020; line-height: 1.2; }
  .user-email { font-size: 12px; color: #888; }

  /* --- STYLE SPÉCIFIQUE LISTES (ACCORDÉON) --- */
  details.list-dropdown {
    position: relative;
    width: 100%;
  }

  details.list-dropdown summary {
    list-style: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #f5f5f5;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #444;
    transition: all 0.2s;
    white-space: nowrap;
  }
  details.list-dropdown summary:hover { background: #eee; color: #000; }
  details.list-dropdown summary::-webkit-details-marker { display: none; }

  /* L'icône chevron qui tourne */
  details.list-dropdown summary::after {
    content: url('data:image/svg+xml;utf8,<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><polyline points="6 9 12 15 18 9"></polyline></svg>');
    display: block;
    width: 12px; height: 12px;
    transition: transform 0.2s;
  }
  details.list-dropdown[open] summary::after { transform: rotate(180deg); }

  /* Contenu déroulant */
  .lists-popover {
    margin-top: 10px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    min-width: 250px;
    max-width: 300px;
    max-height: 200px;
    overflow-y: auto;
    position: absolute; /* Pour ne pas décaler le tableau */
    z-index: 10;
    left: 0;
  }

  /* Ajustement popover si tableau à droite */
  .users-dash-table td:last-child .lists-popover {
    right: 0; left: auto;
  }

  .list-item-link {
    display: block;
    padding: 8px 12px;
    border-radius: 6px;
    color: #333;
    text-decoration: none;
    font-size: 13px;
    border-bottom: 1px solid #f9f9f9;
    transition: background 0.2s;
    white-space: normal; /* Permet au titre de la liste de revenir à la ligne */
  }
  .list-item-link:last-child { border-bottom: none; }
  .list-item-link:hover { background-color: #F3F4F6; color: #202020; }
  .list-item-link span { display: block; font-size: 11px; color: #999; margin-top: 2px; }

  /* --- MEDIA QUERIES --- */

  /* Tablette (< 1024px) */
  @media (max-width: 1024px) {
    .users-dash-kpi-grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* Mobile (< 768px) */
  @media (max-width: 768px) {
    .users-dash-wrapper { padding: 20px 16px 60px 16px; }

    .users-dash-title { font-size: 24px; }

    .users-dash-kpi-grid { grid-template-columns: 1fr; }

    .lists-popover {
      position: fixed; /* Sur mobile, mieux vaut centrer ou fixer si besoin */
      left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 80vw; max-width: 80vw;
    }
  }
</style>
<div class="users-dash-wrapper">
  <div class="users-dash-header">
    <div style="display: flex; align-items: center; gap: 20px;">
      <%= link_to admin_root_path, class: "users-dash-back-link" do %>
        <svg style="width: 24px; height: 24px; fill: #202020;" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      <% end %>
      <h1 class="users-dash-title">Rapport des Listes</h1>
    </div>
  </div>
  <div class="users-dash-kpi-grid">
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Listes Créées</span>
        <div class="kpi-icon bg-indigo-light">
          <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @total_lists %></span>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Créateurs</span>
        <div class="kpi-icon bg-teal-light">
          <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @users_with_lists %></span>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Visiteurs Invités</span>
        <div class="kpi-icon bg-pink-light">
          <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @total_visitors %></span>
    </div>
    <div class="users-dash-kpi-card">
      <div class="kpi-top">
        <span class="kpi-label">Éditeurs Invités</span>
        <div class="kpi-icon bg-amber-light">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        </div>
      </div>
      <span class="kpi-value"><%= @total_editors %></span>
    </div>
  </div>
  <span class="section-title">Top Créateurs de listes</span>
  <div class="users-dash-table-container">
    <table class="users-dash-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Contact</th>
          <th style="text-align: center;">Nb. Listes</th>
          <th>Détail & Accès</th>
        </tr>
      </thead>
      <tbody>
        <% @top_creators.each do |user| %>
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar">
                  <%= user.firstname&.first&.upcase || "?" %>
                </div>
                <div class="user-info">
                  <span class="user-name"><%= user.firstname %> <%= user.lastname %></span>
                  <span class="user-email">ID: #<%= user.id %></span>
                </div>
              </div>
            </td>
            <td><%= mail_to user.email, user.email, style: "color:#666; text-decoration:none;" %></td>
            <td style="text-align: center;">
              <span class="badge badge-green" style="font-size: 14px; background: #E8F5E9; color: #2E7D32; padding: 4px 10px; border-radius: 12px; font-weight: 600;"><%= user.lists_count %></span>
            </td>
            <td>
              <details class="list-dropdown">
                <summary>Voir les listes</summary>
                <div class="lists-popover">
                  <% 
                    user_lists = user.lists.order(updated_at: :desc).limit(10) 
                  %>
                  <% if user_lists.any? %>
                    <% user_lists.each do |list| %>
                      <%= link_to list_path(list), class: "list-item-link", target: "_blank" do %>
                        <strong><%= list.name.presence || "Sans titre" %></strong>
                        <span>Modifié le <%= list.updated_at.strftime("%d/%m/%Y") %></span>
                      <% end %>
                    <% end %>
                    <% if user.lists_count > 10 %>
                      <div style="padding:8px; text-align:center; font-size:11px; color:#999;">
                        + <%= user.lists_count - 10 %> autres listes...
                      </div>
                    <% end %>
                  <% else %>
                    <div style="padding:10px; font-size:12px; color:#999; text-align:center;">Aucune liste accessible</div>
                  <% end %>
                </div>
              </details>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <div style="padding: 24px; display: flex; justify-content: center; border-top: 1px solid #eee;">
      <%= paginate @top_creators, param_name: :creators_page %>
    </div>
  </div>
  <span class="section-title">Utilisateurs les plus invités</span>
  <div class="users-dash-table-container">
    <table class="users-dash-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Contact</th>
          <th style="text-align: right;">Invitations reçues</th>
        </tr>
      </thead>
      <tbody>
        <% @top_invited.each do |user| %>
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar" style="background: #FFF3E0; color: #E65100;">
                  <%= user.firstname&.first&.upcase || "?" %>
                </div>
                <div class="user-info">
                  <span class="user-name"><%= user.firstname %> <%= user.lastname %></span>
                </div>
              </div>
            </td>
            <td><%= user.email %></td>
            <td style="text-align: right;">
              <span style="font-size: 16px; font-weight: 700; color: #202020;"><%= user.invites_count %></span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <div style="padding: 24px; display: flex; justify-content: center; border-top: 1px solid #eee;">
      <%= paginate @top_invited, param_name: :invited_page %>
    </div>
  </div>
</div>
<script>
  // Fermer automatiquement un dropdown quand on en ouvre un autre
  document.addEventListener("click", function(e) {
    if (e.target.tagName === "SUMMARY") {
      document.querySelectorAll("details.list-dropdown[open]").forEach(detail => {
        if (detail !== e.target.parentElement) {
          detail.removeAttribute("open");
        }
      });
    }
  });
</script>